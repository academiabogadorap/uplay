{% extends "base.html" %}
{% block title %}Mi panel{% endblock %}

{% block content %}
<style>
  /* ——— Header compacto ——— */
  .hero{
    position:relative; overflow:hidden; border-radius:16px; padding:14px;
    background:
      radial-gradient(700px 260px at 0% 0%, rgba(138,232,12,.25), transparent 60%),
      radial-gradient(700px 260px at 100% 100%, rgba(246,201,14,.18), transparent 60%),
      linear-gradient(180deg, rgba(0,0,0,.22), rgba(0,0,0,.10));
    border:1px solid rgba(255,255,255,.12); box-shadow:0 14px 40px rgba(0,0,0,.28);
  }
  .hero-top{ display:flex; gap:12px; align-items:flex-end; justify-content:space-between; flex-wrap:wrap; }
  .hero-title{ margin:0; font-family:"Poppins",system-ui; font-weight:800; letter-spacing:.3px; }
  .chips{display:flex; gap:8px; flex-wrap:wrap; margin-top:10px;}
  .chip{ display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px;
         background:rgba(255,255,255,.10); border:1px solid rgba(255,255,255,.16); font-weight:700; }
  .dot{width:8px; height:8px; border-radius:50%;}
  .dot.g{ background:var(--neon); } .dot.y{ background:var(--yellow); } .dot.b{ background:#6EA8FF; }

  /* ——— Layout de secciones ——— */
  .section-grid{
    display:grid; gap:10px; margin-top:12px;
    grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
    align-items:start;
  }
  .list-clean{ list-style:none; padding-left:0; margin:0; }
  .list-clean li{ padding:6px 0; }

  .badge{ display:inline-block; padding:2px 8px; border-radius:999px; background:rgba(255,255,255,.12); border:1px solid rgba(255,255,255,.18); font-size:.8rem;}
  .badge-ok{ background:#153c2a; border-color:#2a8b5f; }
  .badge-warn{ background:#3b2f1b; border-color:#704d1a; }
  .badge-danger{ background:#3b1b1b; border-color:#701a1a; }

  .btn-slim{ height:36px; padding:6px 10px; border-radius:10px; font-weight:700; }
  .btn-ghost{ background:rgba(255,255,255,.10); border:1px solid rgba(255,255,255,.18); }
  .btn-ok{ background:rgba(16,185,129,.2); border:1px solid rgba(16,185,129,.4); }
  .btn-danger{ background:rgba(239,68,68,.18); border:1px solid rgba(239,68,68,.38); }

  /* Tablas/filas compactas */
  .torneos-list{ list-style:none; padding:0; margin:0; }
  .torneos-list li{
    display:flex; gap:8px; align-items:center; justify-content:space-between;
    padding:8px 0; border-top:1px solid rgba(255,255,255,.08);
  }
  .torneo-meta{ font-size:.9rem; color:var(--muted); }

  /* Mis partidos */
  .match-line{ display:flex; gap:8px; align-items:center; justify-content:space-between; padding:8px 0; border-top:1px solid rgba(255,255,255,.08); }
  .match-teams{ font-weight:600; }
  .muted{ color:var(--muted); }
  .disabled{ opacity:.6; pointer-events:none; }
</style>

<!-- ===== HERO ===== -->
<div class="hero">
  <div class="hero-top">
    <div>
      <h2 class="hero-title">¡Hola, {{ jugador.nombre_completo }}!</h2>
      <div class="chips">
        <span class="chip"><span class="dot b"></span> Cat: {{ jugador.categoria.nombre if jugador.categoria else '-' }}</span>
        <span class="chip"><span class="dot g"></span> Puntos: {{ jugador.puntos }}</span>
        {% if en_zona %}<span class="chip badge-ok" style="border:none;">En zona de ascenso</span>{% endif %}
      </div>
    </div>
    <div class="hero-actions">
      <a href="{{ url_for('mi_cambiar_pin') }}" class="btn btn-ghost btn-slim">Cambiar PIN</a>
    </div>
  </div>
</div>

<!-- ===== SECCIONES PRINCIPALES ===== -->
<div class="section-grid">

  <!-- Tareas pendientes -->
  <div class="card">
    {# ---- Defaults seguros ---- #}
    {% set partidos_para_responder = partidos_para_responder if partidos_para_responder is defined else [] %}
    {% set partidos_creados_pend = partidos_creados_pend if partidos_creados_pend is defined else [] %}
    {% set cant_partidos_resultado_para_responder = cant_partidos_resultado_para_responder if cant_partidos_resultado_para_responder is defined else 0 %}
    {% set cant_propuestas_enviadas_pend = cant_propuestas_enviadas_pend if cant_propuestas_enviadas_pend is defined else 0 %}
    {% set cant_pend_sin_result = cant_pend_sin_result if cant_pend_sin_result is defined else 0 %}
    {% set desafios_para_responder = desafios_para_responder if desafios_para_responder is defined else [] %}
    {% set cant_torneo_partidos_pend = cant_torneo_partidos_pend if cant_torneo_partidos_pend is defined else 0 %}
    {% set cant_abiertos_mi_cat = cant_abiertos_mi_cat if cant_abiertos_mi_cat is defined else 0 %}

    {# ---- Contadores base ---- #}
    {% set cant_part_pend = partidos_para_responder|length %}
    {% set cant_creados_pend = partidos_creados_pend|length %}
    {% set cant_responder_result = cant_partidos_resultado_para_responder %}
    {% set cant_prop_enviadas = cant_propuestas_enviadas_pend %}
    {% set cant_para_proponer = cant_pend_sin_result %}
    {% set cant_desaf_pend = desafios_para_responder|length %}
    {% set cant_torneo_partidos_pend = cant_torneo_partidos_pend %}

    {# ---- TOTAL ---- #}
    {% set cant_total_tareas = cant_part_pend + cant_creados_pend + cant_responder_result + cant_prop_enviadas + cant_para_proponer + cant_desaf_pend + cant_torneo_partidos_pend %}

    {# ==== HREF para "Responder ahora" (ir directo al primer pendiente) ==== #}
    {% set prr = partidos_resultado_para_responder if partidos_resultado_para_responder is defined else [] %}
    {% set tprr = torneo_partidos_resultado_para_responder if torneo_partidos_resultado_para_responder is defined else [] %}
    {% set responder_now_href = None %}

    {# 1) Prioridad: normales #}
    {% if prr and prr|length > 0 %}
      {% set p0 = prr[0] %}
      {% if p0 and p0.id %}
        {% set responder_now_href = url_for('partidos_confirmar_resultado', partido_id=p0.id) %}
      {% endif %}
    {% endif %}

    {# 2) Si no, torneo #}
    {% if (not responder_now_href) and tprr and tprr|length > 0 %}
      {% set it0 = tprr[0] %}
      {% if it0 is mapping %}
        {% set pid_raw = it0.get('partido_id') or it0.get('id') %}
      {% else %}
        {% set pid_raw = (it0.partido_id if it0.partido_id is defined else (it0.id if it0.id is defined else None)) %}
      {% endif %}
      {% set pid_str = pid_raw|string %}
      {% if pid_str.isdigit() %}
        {% set responder_now_href = url_for('torneo_partido_responder', partido_id=pid_str|int) %}
      {% endif %}
    {% endif %}

    <h3>
      Tareas pendientes
      <span class="badge" title="Invitaciones, creados por mí, resultados (responder/proponer/enviadas), desafíos y partidos de torneo">{{ cant_total_tareas }}</span>
    </h3>

    <ul class="list-clean">
      {% if cant_part_pend > 0 %}
        <li>Tenés <strong>{{ cant_part_pend }}</strong> invitación(es) a partido.
          <a href="#partidos-para-responder" class="btn btn-ghost btn-slim">Ver</a>
        </li>
      {% else %}
        <li class="muted">No tenés partidos para responder invitación.</li>
      {% endif %}

      {% if cant_creados_pend > 0 %}
        <li>Tenés <strong>{{ cant_creados_pend }}</strong> partido(s) creados por vos esperando aceptación.
          <a href="#partidos-creados-pend" class="btn btn-ghost btn-slim">Ver</a>
        </li>
      {% else %}
        <li class="muted">No tenés partidos creados pendientes de aceptación.</li>
      {% endif %}

      {% if cant_responder_result > 0 %}
        <li>Tenés <strong>{{ cant_responder_result }}</strong> partido(s) para <strong>responder resultado</strong>.
          {% if responder_now_href %}
            <a href="{{ responder_now_href }}" class="btn btn-ghost btn-slim">Responder ahora</a>
          {% else %}
            <a href="#partidos-resultado-para-responder" class="btn btn-ghost btn-slim">Responder ahora</a>
          {% endif %}
        </li>
      {% else %}
        <li class="muted">No tenés partidos para responder resultado.</li>
      {% endif %}

      {% if cant_prop_enviadas > 0 %}
        <li>Tenés <strong>{{ cant_prop_enviadas }}</strong> propuesta(s) de resultado <strong>enviadas</strong> esperando confirmación.
          <a href="#propuestas-enviadas-pend" class="btn btn-ghost btn-slim">Ver</a>
        </li>
      {% endif %}

      {% if cant_para_proponer > 0 %}
        <li>Tenés <strong>{{ cant_para_proponer }}</strong> partido(s) para <strong>proponer resultado</strong>.
          <a href="#partidos-sin-resultado" class="btn btn-ghost btn-slim">Ver</a>
          <a href="{{ url_for('partidos_list') }}" class="btn btn-ghost btn-slim">Cargar ahora</a>
        </li>
      {% else %}
        {% if cant_responder_result == 0 and cant_prop_enviadas == 0 %}
          <li class="muted">No tenés partidos pendientes de resultado.</li>
        {% endif %}
      {% endif %}

      {% if cant_torneo_partidos_pend > 0 %}
        <li>Tenés <strong>{{ cant_torneo_partidos_pend }}</strong> partido(s) de <strong>torneo</strong> pendientes.
          <a href="#torneo-partidos-pend" class="btn btn-ghost btn-slim">Ver</a>
        </li>
      {% else %}
        <li class="muted">No tenés partidos de torneo pendientes.</li>
      {% endif %}

      {% if cant_desaf_pend > 0 %}
        <li>Te desafiaron en <strong>{{ cant_desaf_pend }}</strong> desafío(s).
          <a href="{{ url_for('desafios_list') }}" class="btn btn-ghost btn-slim">Ver</a>
        </li>
      {% else %}
        <li class="muted">No tenés desafíos para responder.</li>
      {% endif %}

      {% if cant_abiertos_mi_cat > 0 %}
        <li>Hay <strong>{{ cant_abiertos_mi_cat }}</strong> abiertos en tu categoría.
          <a href="{{ url_for('abiertos_list') }}" class="btn btn-ghost btn-slim">Ver</a>
        </li>
      {% else %}
        <li>No hay abiertos en tu categoría.
          <a href="{{ url_for('abiertos_list') }}" class="btn btn-ghost btn-slim" style="margin-left:4px;">Crear uno</a>
        </li>
      {% endif %}
    </ul>
  </div>

  <!-- Suplencias activas -->
  {% if suplencias is defined and suplencias and suplencias|length > 0 %}
  <div id="suplencias-activas" class="card">
    <h3>Suplencias activas</h3>
    <ul class="list-clean">
      {% for s in suplencias %}
        {% set pa = s.partido_abierto %}
        <li>
          <span class="badge">Abierto #{{ pa.id }}</span>
          — {{ pa.categoria.nombre if pa.categoria else '-' }}
          — {{ pa.nota or 'Sin nota' }}
          — Inscriptos: {{ pa.inscriptos|length if pa.inscriptos else 0 }}/4
          — <span class="badge {% if pa.estado=='ABIERTO' %}badge-ok{% elif pa.estado in ['LLENO','PARTIDO_CREADO'] %}badge-warn{% elif pa.estado=='CANCELADO' %}badge-danger{% endif %}">{{ pa.estado }}</span>
          <form method="post" action="{{ url_for('abiertos_suplente_quitar', pa_id=pa.id) }}" style="display:inline; margin-left:6px;">
            <button type="submit" class="btn btn-ghost btn-slim">Quitarme</button>
          </form>
        </li>
      {% endfor %}
    </ul>
  </div>
  {% endif %}

  <!-- Desafiar nivel superior -->
  <div class="card">
    <h3>Desafiar nivel superior</h3>
    {% if en_zona and cat_superior %}
      <p>Podés desafiar a <strong>{{ cat_superior.nombre }}</strong>. Elegí compañero y rivales:</p>
      {% if rivales_superior %}
        <ul class="list-clean" style="max-height:160px; overflow:auto;">
          {% for r in rivales_superior %}
            <li>{{ r.nombre_completo }} — {{ r.puntos }} pts</li>
          {% endfor %}
        </ul>
      {% else %}
        <p class="muted">No hay rivales listados aún en {{ cat_superior.nombre }}.</p>
      {% endif %}
      <p style="margin-top:6px;">
        <a href="{{ url_for('desafios_new', desafiante_id=jugador.id) }}" class="btn btn-ok btn-slim">Crear desafío</a>
      </p>
    {% elif not cat_superior %}
      <p class="muted">Estás en la categoría más alta.</p>
    {% else %}
      <p class="muted">Necesitás estar en zona de ascenso para desafiar.</p>
      <a href="{{ url_for('ranking') }}" class="btn btn-ghost btn-slim">Ver ranking</a>
    {% endif %}
  </div>

  <!-- Novedades de torneos -->
  <div class="card">
    <h3>Novedades de torneos</h3>

    {% if torneos_mi_cat is defined and torneos_mi_cat and torneos_mi_cat|length > 0 %}
      <h4 style="margin:6px 0 4px;">De tu categoría</h4>
      <ul class="torneos-list">
        {% for t in torneos_mi_cat %}
          <li>
            <div>
              <strong>{{ t.nombre }}</strong>
              <div class="torneo-meta">
                {% if t.fecha_inicio %}Desde {{ t.fecha_inicio.strftime('%d/%m') }}{% endif %}
                {% if t.sede %} — {{ t.sede }}{% endif %}
                {% if t.formato %} — {{ t.formato }}{% endif %}
                {% if t.modalidad %} — {{ t.modalidad }}{% endif %}
              </div>
            </div>
            <div style="display:flex; gap:6px; flex-wrap:wrap;">
              <a href="{{ url_for('torneo_public_detail', torneo_id=t.id) }}" class="btn btn-slim">Ver</a>
              <a href="{{ url_for('torneo_public_detail', torneo_id=t.id) }}#inscripcion" class="btn btn-ghost btn-slim">Inscribirme</a>
              <a href="{{ url_for('torneo_public_fixture', torneo_id=t.id) }}" class="btn btn-ghost btn-slim">Fixture</a>
              <a href="{{ url_for('torneo_public_tabla', torneo_id=t.id) }}" class="btn btn-ghost btn-slim">Tabla</a>
            </div>
          </li>
        {% endfor %}
      </ul>
    {% endif %}

    {% set abiertos = torneos_abiertos if torneos_abiertos is defined else [] %}
    {% set proximos = torneos_proximos if torneos_proximos is defined else [] %}

    {% if (abiertos|length == 0) and (proximos|length == 0) and (not torneos_mi_cat or torneos_mi_cat|length == 0) %}
      <p class="muted">Sin novedades por ahora.</p>
    {% endif %}

    {% if abiertos and abiertos|length > 0 %}
      <h4 style="margin:6px 0 4px;">Inscripción abierta</h4>
      <ul class="torneos-list">
        {% for t in abiertos[:5] %}
          <li>
            <div>
              <strong>{{ t.nombre }}</strong>
              <div class="torneo-meta">
                {% if t.fecha_inicio %}Desde {{ t.fecha_inicio.strftime('%d/%m') }} — {% endif %}
                Cupos: {{ t.cupos_disponibles if t.cupos_disponibles is defined else '—' }}
              </div>
            </div>
            <div>
              {% if t.id %}
                <a href="{{ url_for('torneo_public_detail', torneo_id=t.id) }}" class="btn btn-slim">Ver</a>
              {% else %}
                <a href="{{ url_for('torneos_public_list', estado='INSCRIPCION') }}" class="btn btn-slim">Ver</a>
              {% endif %}
            </div>
          </li>
        {% endfor %}
      </ul>
    {% endif %}

    {% if proximos and proximos|length > 0 %}
      <h4 style="margin:10px 0 4px;">Próximos</h4>
      <ul class="torneos-list">
        {% for t in proximos[:5] %}
          <li>
            <div>
              <strong>{{ t.nombre }}</strong>
              <div class="torneo-meta">
                {% if t.fecha_inicio %}{{ t.fecha_inicio.strftime('%d/%m') }}{% endif %}
                {% if t.sede %} — {{ t.sede }}{% endif %}
              </div>
            </div>
            <div>
              {% if t.id %}
                <a href="{{ url_for('torneo_public_detail', torneo_id=t.id) }}" class="btn btn-ghost btn-slim">Info</a>
              {% else %}
                <a href="{{ url_for('torneos_public_list') }}" class="btn btn-ghost btn-slim">Ver todos</a>
              {% endif %}
            </div>
          </li>
        {% endfor %}
      </ul>
    {% endif %}

    <p style="margin-top:8px;">
      <a href="{{ url_for('torneos_public_list') }}" class="btn btn-ghost btn-slim">Ir a torneos</a>
    </p>
  </div>

</div>

<!-- ===== DETALLES ENLAZADOS DESDE “Tareas pendientes” ===== -->

{% if partidos_para_responder and partidos_para_responder|length > 0 %}
  <div id="partidos-para-responder" class="card" style="margin-top:12px;">
    <h3>Partidos para responder (invitación)</h3>
    <ul class="list-clean">
      {% for p in partidos_para_responder %}
        <li>
          <span class="badge">#{{ p.id }}</span>
          {% if p.categoria %}[{{ p.categoria.nombre }}]{% endif %}
          — Propuesto por: {{ p.creador.nombre_completo if p.creador else '(creador desconocido)' }}<br>
          Tu equipo:
          {% if p.companero %}{{ jugador.nombre_completo }} + {{ p.companero.nombre_completo }}
          {% else %}{{ jugador.nombre_completo }} + <span class="muted">(sin compañero)</span>{% endif %}<br>
          Rivales: {% if p.rival1 and p.rival2 %}{{ p.rival1.nombre_completo }} + {{ p.rival2.nombre_completo }}{% else %}<span class="muted">(incompletos)</span>{% endif %}
          <a href="{{ url_for('partidos_responder', partido_id=p.id) }}" class="btn btn-ok btn-slim" style="margin-left:6px;">Responder</a>
        </li>
      {% endfor %}
    </ul>
  </div>
{% endif %}

{% if partidos_creados_pend and partidos_creados_pend|length > 0 %}
  <div id="partidos-creados-pend" class="card" style="margin-top:12px;">
    <h3>Partidos creados por mí (esperando aceptación)</h3>
    <ul class="list-clean">
      {% for p in partidos_creados_pend %}
        <li>
          <span class="badge">#{{ p.id }}</span>
          {% if p.categoria %}[{{ p.categoria.nombre }}]{% endif %}
          — Estado: {{ p.estado }} — Falta aceptación de:
          {% set faltan = [] %}
          {% if p.rival1 and p.rival1_acepto is none %}{% set _ = faltan.append(p.rival1.nombre_completo) %}{% endif %}
          {% if p.rival2 and p.rival2_acepto is none %}{% set _ = faltan.append(p.rival2.nombre_completo) %}{% endif %}
          {{ faltan|join(' y ') if faltan else '—' }}
        </li>
      {% endfor %}
    </ul>
  </div>
{% endif %}

{# ============ RESPONDER RESULTADO (liga + torneo) ============ #}
{% set partidos_resultado_para_responder = partidos_resultado_para_responder if partidos_resultado_para_responder is defined else [] %}
{% set torneo_partidos_resultado_para_responder = torneo_partidos_resultado_para_responder if torneo_partidos_resultado_para_responder is defined else [] %}
{% set hay_normales = partidos_resultado_para_responder|length > 0 %}
{% set hay_torneo   = torneo_partidos_resultado_para_responder|length > 0 %}

{% if hay_normales or hay_torneo %}
  <div id="partidos-resultado-para-responder" class="card" style="margin-top:12px;">
    <h3>Partidos para responder resultado</h3>

    {% if hay_normales %}
      <h4 style="margin:6px 0 4px;">Liga / Abiertos</h4>
      <ul class="list-clean">
        {% for p in partidos_resultado_para_responder %}
          <li>
            <span class="badge">#{{ p.id }}</span>
            {% if p.categoria %}[{{ p.categoria.nombre }}]{% endif %}
            {% set p1 = p.pareja1 %}{% set p2 = p.pareja2 %}
            {% set p1n1 = p1.jugador1.nombre_completo if p1 and p1.jugador1 else '—' %}
            {% set p1n2 = p1.jugador2.nombre_completo if p1 and p1.jugador2 else '—' %}
            {% set p2n1 = p2.jugador1.nombre_completo if p2 and p2.jugador1 else '—' %}
            {% set p2n2 = p2.jugador2.nombre_completo if p2 and p2.jugador2 else '—' %}
            — {{ p1n1 }} + {{ p1n2 }} vs {{ p2n1 }} + {{ p2n2 }}
            {% if p.fecha %}<span class="muted"> — {{ p.fecha.strftime('%Y-%m-%d %H:%M') }}</span>{% endif %}
            <a href="{{ url_for('partidos_confirmar_resultado', partido_id=p.id) }}"
               class="btn btn-ok btn-slim" style="margin-left:6px;">Responder resultado</a>
          </li>
        {% endfor %}
      </ul>
    {% endif %}

    {% if hay_torneo %}
      <h4 style="margin:10px 0 4px;">Torneo</h4>
      <ul class="list-clean">
        {% for it in torneo_partidos_resultado_para_responder %}
          {# pid: acepta dict u objeto #}
          {% set pid_raw = (
              it['partido_id'] if it is mapping and 'partido_id' in it else
              (it['id'] if it is mapping and 'id' in it else
               (it.partido_id if it.partido_id is defined else (it.id if it.id is defined else None)))
            ) %}
          {% set pid_str = pid_raw|string %}
          {% set pid_ok = pid_str.isdigit() %}
          {# nombres #}
          {% if it is mapping %}
            {% set an = it.get('a_nombres') %}
            {% set bn = it.get('b_nombres') %}
            {% set st = it.get('sets_text') %}
          {% else %}
            {% set an = it.a_nombres if it.a_nombres is defined else None %}
            {% set bn = it.b_nombres if it.b_nombres is defined else None %}
            {% set st = it.sets_text if it.sets_text is defined else None %}
          {% endif %}
          <li>
            <span class="badge">Torneo #{{ pid_ok and pid_str or '—' }}</span>
            {% if an or bn %} — {{ an or '—' }} vs {{ bn or '—' }}{% endif %}
            {% if st %}<span class="muted"> — Propuesto: {{ st }}</span>{% endif %}
            {% if pid_ok %}
              <a href="{{ url_for('torneo_partido_responder', partido_id=pid_str|int) }}"
                 class="btn btn-ok btn-slim" style="margin-left:6px;">Responder resultado</a>
            {% else %}
              <span class="btn btn-ghost btn-slim disabled" title="Falta ID de partido">Responder resultado</span>
            {% endif %}
          </li>
        {% endfor %}
      </ul>
    {% endif %}
  </div>
{% endif %}

{# Propuestas enviadas por mí (pendientes de confirmación) #}
{% set partidos_propuestas_enviadas_pend = partidos_propuestas_enviadas_pend if partidos_propuestas_enviadas_pend is defined else [] %}
{% set propuestas_map = propuestas_map if propuestas_map is defined else {} %}
{% if partidos_propuestas_enviadas_pend|length > 0 %}
  <div id="propuestas-enviadas-pend" class="card" style="margin-top:12px;">
    <h3>Propuestas enviadas (pendientes de confirmación)</h3>
    <ul class="list-clean">
      {% for p in partidos_propuestas_enviadas_pend %}
        {% set pr = propuestas_map.get(p.id) %}
        <li class="match-line">
          <div>
            <span class="badge">#{{ p.id }}</span>
            {% if p.categoria %}[{{ p.categoria.nombre }}]{% endif %}
            <span class="match-teams">
              {% set p1 = p.pareja1 %}{% set p2 = p.pareja2 %}
              {% set p1n1 = p1.jugador1.nombre_completo if p1 and p1.jugador1 else '—' %}
              {% set p1n2 = p1.jugador2.nombre_completo if p1 and p1.jugador2 else '—' %}
              {% set p2n1 = p2.jugador1.nombre_completo if p2 and p2.jugador1 else '—' %}
              {% set p2n2 = p2.jugador2.nombre_completo if p2 and p2.jugador2 else '—' %}
              — {{ p1n1 }} + {{ p1n2 }} vs {{ p2n1 }} + {{ p2n2 }}
            </span>
            {% if p.fecha %}<span class="muted"> — {{ p.fecha.strftime('%Y-%m-%d %H:%M') }}</span>{% endif %}
            {% if pr and (pr.resumen or pr.resultado_str) %}
              <div class="muted" style="margin-top:2px;">Propuesto: {{ pr.resumen or pr.resultado_str }}</div>
            {% endif %}
          </div>
          <div class="muted">Esperando confirmación del rival…</div>
        </li>
      {% endfor %}
    </ul>
  </div>
{% endif %}

{# Partidos donde yo puedo proponer resultado #}
{% set partidos_sin_resultado = partidos_sin_resultado if partidos_sin_resultado is defined else [] %}
{% if partidos_sin_resultado|length > 0 %}
  <div id="partidos-sin-resultado" class="card" style="margin-top:12px;">
    <h3>Partidos para proponer resultado</h3>
    <ul class="list-clean">
      {% for m in partidos_sin_resultado %}
        <li class="match-line">
          <div>
            <span class="badge">#{{ m.id }}</span>
            {% if m.categoria %}[{{ m.categoria.nombre }}]{% endif %}
            <span class="match-teams">
              {% set p1 = m.pareja1 %}{% set p2 = m.pareja2 %}
              {% set p1n1 = p1.jugador1.nombre_completo if p1 and p1.jugador1 else '—' %}
              {% set p1n2 = p1.jugador2.nombre_completo if p1 and p1.jugador2 else '—' %}
              {% set p2n1 = p2.jugador1.nombre_completo if p2 and p2.jugador1 else '—' %}
              {% set p2n2 = p2.jugador2.nombre_completo if p2 and p2.jugador2 else '—' %}
              — {{ p1n1 }} + {{ p1n2 }} vs {{ p2n1 }} + {{ p2n2 }}
            </span>
            {% if m.fecha %}<span class="muted"> — {{ m.fecha.strftime('%Y-%m-%d %H:%M') }}</span>{% endif %}
          </div>
          <div><a href="{{ url_for('partidos_list') }}" class="btn btn-ghost btn-slim">Cargar resultado</a></div>
        </li>
      {% endfor %}
    </ul>
  </div>
{% endif %}

{# ===== Partidos de TORNEO pendientes ===== #}
{% set partidos_torneo_pend = partidos_torneo_pend if partidos_torneo_pend is defined else [] %}
{% if partidos_torneo_pend|length > 0 %}
  <div id="torneo-partidos-pend" class="card" style="margin-top:12px;">
    <h3>Partidos de torneo pendientes</h3>
    <ul class="list-clean">
      {% for p in partidos_torneo_pend %}
        {# pid #}
        {% set pid_raw = (
            p['id'] if p is mapping and 'id' in p else
            (p['partido_id'] if p is mapping and 'partido_id' in p else
             (p.id if p.id is defined else (p.partido_id if p.partido_id is defined else None)))
          ) %}
        {% set pid_str = pid_raw|string %}
        {% set pid_ok = pid_str.isdigit() %}

        {# otros campos #}
        {% if p is mapping %}
          {% set a_nom = p.get('a_nombres') %}
          {% set b_nom = p.get('b_nombres') %}
          {% set rnda = p.get('ronda') %}
          {% set ord = p.get('orden') %}
          {% set prog = p.get('programado_en') %}
          {% set cancha = p.get('cancha') %}
          {% set torneo_obj = p.get('torneo') %}
        {% else %}
          {% set a_nom = p.a_nombres if p.a_nombres is defined else None %}
          {% set b_nom = p.b_nombres if p.b_nombres is defined else None %}
          {% set rnda = p.ronda if p.ronda is defined else None %}
          {% set ord = p.orden if p.orden is defined else None %}
          {% set prog = p.programado_en if p.programado_en is defined else None %}
          {% set cancha = p.cancha if p.cancha is defined else None %}
          {% set torneo_obj = p.torneo if p.torneo is defined else None %}
        {% endif %}

        <li class="match-line">
          <div>
            <span class="badge">#{{ pid_ok and pid_str or '—' }}</span>
            <span class="match-teams">
              — {{ a_nom or '—' }} vs {{ b_nom or '—' }}
            </span>
            <span class="muted">
              {% if rnda is not none %} · Ronda {{ rnda }}{% endif %}
              {% if ord is not none %} · Orden {{ ord }}{% endif %}
              {% if prog %} · {{ prog.strftime('%d/%m %H:%M') }}{% endif %}
              {% if cancha %} · Cancha: {{ cancha }}{% endif %}
              {% if torneo_obj and torneo_obj.nombre %} · Torneo: {{ torneo_obj.nombre }}{% endif %}
            </span>
          </div>
          <div style="display:flex; gap:6px; flex-wrap:wrap;">
            {% if pid_ok %}
              <a href="{{ url_for('torneo_partido_detalle', partido_id=pid_str|int) }}" class="btn btn-slim">Ver</a>
              <a href="{{ url_for('torneo_partido_proponer', partido_id=pid_str|int) }}" class="btn btn-ghost btn-slim">Proponer resultado</a>
              <a href="{{ url_for('torneo_partido_responder', partido_id=pid_str|int) }}" class="btn btn-ghost btn-slim">Responder resultado</a>
            {% else %}
              <span class="btn btn-slim disabled" title="Falta ID de partido">Ver</span>
              <span class="btn btn-ghost btn-slim disabled" title="Falta ID de partido">Proponer resultado</span>
              <span class="btn btn-ghost btn-slim disabled" title="Falta ID de partido">Responder resultado</span>
            {% endif %}
          </div>
        </li>
      {% endfor %}
    </ul>
  </div>
{% endif %}

<!-- ===== MIS PARTIDOS ===== -->
<div class="card" style="margin-top:12px;">
  <h3>Mis partidos</h3>

  <h4 style="margin:6px 0 4px;">Por jugar</h4>
  {% set partidos_pend = partidos_pend if partidos_pend is defined else [] %}
  {% if partidos_pend|length > 0 %}
    <ul class="list-clean">
      {% for m in partidos_pend %}
        <li class="match-line">
          <div>
            <span class="badge">#{{ m.id }}</span>
            {% if m.categoria %}[{{ m.categoria.nombre }}]{% endif %}
            <span class="match-teams">
              {% set p1 = m.pareja1 %}
              {% set p2 = m.pareja2 %}
              {% set p1n1 = p1.jugador1.nombre_completo if p1 and p1.jugador1 else '—' %}
              {% set p1n2 = p1.jugador2.nombre_completo if p1 and p1.jugador2 else '—' %}
              {% set p2n1 = p2.jugador1.nombre_completo if p2 and p2.jugador1 else '—' %}
              {% set p2n2 = p2.jugador2.nombre_completo if p2 and p2.jugador2 else '—' %}
              — {{ p1n1 }} + {{ p1n2 }} vs {{ p2n1 }} + {{ p2n2 }}
            </span>
            {% if m.fecha %}<span class="muted"> — {{ m.fecha.strftime('%Y-%m-%d %H:%M') }}</span>{% endif %}
          </div>
          <div>
            <span class="badge {% if m.estado in ['POR_CONFIRMAR','PENDIENTE'] %}badge-warn{% else %}badge-ok{% endif %}">{{ m.estado }}</span>
          </div>
        </li>
      {% endfor %}
    </ul>
  {% else %}
    <p class="muted">No tenés partidos por jugar.</p>
  {% endif %}

  <h4 style="margin:10px 0 4px;">Últimos jugados</h4>
  {% set partidos_jug = partidos_jug if partidos_jug is defined else [] %}
  {% if partidos_jug|length > 0 %}
    <ul class="list-clean">
      {% for m in partidos_jug %}
        <li class="match-line">
          <div>
            <span class="badge">#{{ m.id }}</span>
            {% if m.categoria %}[{{ m.categoria.nombre }}]{% endif %}
            <span class="match-teams">
              {% set p1 = m.pareja1 %}
              {% set p2 = m.pareja2 %}
              {% set p1n1 = p1.jugador1.nombre_completo if p1 and p1.jugador1 else '—' %}
              {% set p1n2 = p1.jugador2.nombre_completo if p1 and p1.jugador2 else '—' %}
              {% set p2n1 = p2.jugador1.nombre_completo if p2 and p2.jugador1 else '—' %}
              {% set p2n2 = p2.jugador2.nombre_completo if p2 and p2.jugador2 else '—' %}
              — {{ p1n1 }} + {{ p1n2 }} vs {{ p2n1 }} + {{ p2n2 }}
            </span>
            {% if m.fecha %}<span class="muted"> — {{ m.fecha.strftime('%Y-%m-%d %H:%M') }}</span>{% endif %}
          </div>
          <div>
            <span class="badge badge-ok">{{ m.estado }}</span>
          </div>
        </li>
      {% endfor %}
    </ul>
  {% else %}
    <p class="muted">Aún no registraste partidos jugados.</p>
  {% endif %}
</div>

{% endblock %}

{% block help_content %}
{{ super() }}
{% endblock %}
