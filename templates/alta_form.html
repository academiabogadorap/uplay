{% extends "base.html" %}
{% block title %}Solicitud de alta{% endblock %}

{% block content %}
<style>
  /* ===== Hero / cabecera (mismo que index/login) ===== */
  .hero{
    position:relative; overflow:hidden;
    border-radius:16px; padding:14px;
    background:
      radial-gradient(700px 260px at 0% 0%, rgba(138,232,12,.25), transparent 60%),
      radial-gradient(700px 260px at 100% 100%, rgba(246,201,14,.18), transparent 60%),
      linear-gradient(180deg, rgba(0,0,0,.22), rgba(0,0,0,.10));
    border:1px solid rgba(255,255,255,.12);
    box-shadow:0 14px 40px rgba(0,0,0,.28);
  }
  .hero-top{ display:flex; gap:12px; align-items:flex-end; justify-content:space-between; flex-wrap:wrap; }
  .hero-title{ margin:0; font-family:"Poppins",system-ui; font-weight:800; letter-spacing:.3px; }
  .hero-tag{
    margin:0; text-transform:uppercase; font-weight:800; letter-spacing:.14em; line-height:1;
    font-size:clamp(.78rem, 1.6vw, .92rem);
    background: linear-gradient(90deg, var(--yellow), var(--neon));
    -webkit-background-clip:text; background-clip:text; color:transparent;
    filter: drop-shadow(0 0 .15em rgba(0,0,0,.25)); opacity:.95;
  }
  .hero-actions{display:flex; gap:10px; flex-wrap:wrap;}

  /* ===== Chips / stats ===== */
  .chips{display:flex; gap:8px; flex-wrap:wrap; margin-top:10px;}
  .chip{
    display:inline-flex; align-items:center; gap:8px;
    padding:6px 10px; border-radius:999px;
    background:rgba(255,255,255,.10); border:1px solid rgba(255,255,255,.16);
    font-weight:700;
  }
  .chip .dot{width:8px; height:8px; border-radius:50%;}
  .dot-green{background:var(--neon);} .dot-yellow{background:var(--yellow);}
  .dot-blue{background:#6EA8FF;}

  /* ===== Layout de contenido ===== */
  .page-wrap{ display:grid; gap:10px; margin-top:12px; grid-template-columns: minmax(280px, 1fr); }

  /* Tarjeta */
  .card{ border-radius:14px; border:1px solid rgba(255,255,255,.12);
         background:linear-gradient(180deg, var(--panel), var(--panel-2)); padding:10px; }
  .card-form{ max-width: 720px; }

  /* ===== Inputs/Selects ===== */
  .form-row{ display:block; }
  .form-label{ display:block; margin-bottom:4px; color:var(--muted); }
  .form-input, .form-select{
    width:100%;
    border-radius:10px;
    padding:10px 12px;
    background:rgba(255,255,255,.06);
    border:1px solid rgba(255,255,255,.14);
    color:#fff;
    outline:none;
  }
  .form-input:focus, .form-select:focus{
    border-color: rgba(16,185,129,.45);
    box-shadow: 0 0 0 3px rgba(16,185,129,.18);
  }

  .form-select{
    -webkit-appearance:none; -moz-appearance:none; appearance:none;
    padding-right:38px;
    background-image: url("data:image/svg+xml,%3Csvg width='20' height='20' viewBox='0 0 24 24' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M6 9l6 6 6-6' stroke='%23FFFFFF' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
    background-repeat:no-repeat; background-position: right 10px center; background-size: 18px 18px;
  }
  .form-select option{ color:#111; background:#fff; }
  .form-select option[disabled]{ color:#9aa3af; }
  .form-select::-ms-expand{ display:none; }

  .btn-slim{ height:36px; padding:6px 10px; border-radius:10px; font-weight:700; }
  .btn-ghost{ background:rgba(255,255,255,.10); border:1px solid rgba(255,255,255,.18); }
  .btn{ background:rgba(255,255,255,.95); color:#111; border:1px solid rgba(255,255,255,.95); border-radius:12px; font-weight:800; padding:10px 14px; }
  .btn:focus{ outline:none; box-shadow:0 0 0 3px rgba(255,255,255,.35); }

  .help-note{ color:var(--muted); margin:6px 0 0; font-size:.92rem; }
</style>

<!-- ===== HERO ===== -->
<div class="hero">
  <div class="hero-top">
    <div>
      <h1 class="hero-title">UPLAY</h1>
      <p class="hero-tag">Solicitud de alta</p>
    </div>
    <div class="hero-actions">
      <a href="{{ url_for('login') }}" class="btn-ghost btn-slim">Volver a Iniciar sesión</a>
    </div>
  </div>
  <p class="muted" style="margin:10px 0 0;">Completá tus datos y un administrador aprobará tu acceso.</p>
</div>

<!-- ===== CONTENIDO ===== -->
<div class="page-wrap">

  <div class="card card-form">
    <!-- Hacemos explícito el action hacia la ruta correcta -->
    <form method="post" action="{{ url_for('alta_publica') }}" style="display:grid; gap:10px;">
      <div class="form-row">
        <label for="nombre_completo" class="form-label">Nombre completo</label>
        <input id="nombre_completo" name="nombre_completo" required placeholder="EJ: JUAN PÉREZ" class="form-input" autocomplete="name" autofocus>
        <small class="muted">Se guardará en mayúsculas.</small>
      </div>

      <div class="form-row">
        <label for="email" class="form-label">Email</label>
        <input id="email" name="email" type="email" required placeholder="tucorreo@ejemplo.com" class="form-input" autocomplete="email" inputmode="email">
      </div>

      <!-- Teléfono dividido: código de país + número local -->
      <div class="form-row">
        <label class="form-label">Teléfono</label>
        <div style="display:flex; gap:8px; align-items:center;">
          <div style="min-width:110px;">
            <div style="display:flex; align-items:center; gap:6px;">
              <span class="form-label" style="margin:0; color:var(--muted)">País</span>
              <!-- CC: 1–4 dígitos, por defecto 54 -->
              <input id="tel_cc" name="tel_cc" type="text" inputmode="numeric"
                     pattern="[0-9]{1,4}" maxlength="4" value="54" autocomplete="tel-country-code"
                     class="form-input" style="width:90px;" aria-label="Código de país"
                     placeholder="Ej: 54"
                     title="Ingresá solo dígitos (1 a 4). Ej: 54 para Argentina">
            </div>
          </div>
          <div style="flex:1;">
            <!-- Local: 7–15 dígitos (sin +). Backend exige mínimo 7 -->
            <input id="tel_local" name="tel_local" type="text" inputmode="numeric"
                   pattern="[0-9]{7,15}" maxlength="18" required
                   placeholder="Ej: 11 12345678" aria-label="Número con característica (sin +)"
                   class="form-input" autocomplete="tel-national"
                   title="Ingresá solo dígitos (7 a 15). Ej: 1112345678">
          </div>
        </div>
        <small class="help-note">Ingresá solo números. Ejemplo AR: País <strong>54</strong> y Local <strong>1112345678</strong> → se guarda como <code>+541112345678</code>.</small>
        <!-- Compat backend anterior: lo dejamos vacío (el server usa tel_cc+tel_local) -->
        <input type="hidden" name="telefono" id="telefono_compat" value="">
      </div>

      <!-- ====== Datos personales ====== -->
      <div class="form-row" style="margin-top:6px;">
        <label class="form-label" style="font-weight:800;">Datos personales</label>
        <div style="display:grid; gap:10px; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));">
          <!-- País -->
          <div>
            <label for="pais" class="form-label">País</label>
            <select id="pais" name="pais" class="form-select" autocomplete="country-name">
              <option value="">-- Seleccioná --</option>
              <option value="Argentina" selected>Argentina</option>
              <option value="Brasil">Brasil</option>
              <option value="Chile">Chile</option>
              <option value="Uruguay">Uruguay</option>
              <option value="Paraguay">Paraguay</option>
              <option value="Otro">Otro</option>
            </select>
          </div>

          <!-- Provincia / Estado -->
          <div>
            <label for="provincia" class="form-label">Provincia / Estado</label>
            <select id="provincia" name="provincia" class="form-select" autocomplete="address-level1">
              <option value="">-- Seleccioná --</option>
            </select>
            <small class="help-note" id="provincia-ayuda">Si tu país no es Argentina, podés dejarlo vacío o indicar tu estado en “Ciudad”.</small>
          </div>

          <!-- Ciudad -->
          <div>
            <label for="ciudad" class="form-label">Ciudad</label>
            <input id="ciudad" name="ciudad" type="text" placeholder="Ej: Viedma" class="form-input" autocomplete="address-level2" />
          </div>

          <!-- Fecha de nacimiento -->
          <div>
            <label for="fecha_nacimiento" class="form-label">Fecha de nacimiento</label>
            <input id="fecha_nacimiento" name="fecha_nacimiento" type="date" class="form-input" />
            <small class="help-note">Usamos esta info para categorías y reportes (opcional).</small>
          </div>
        </div>
      </div>
      <!-- ====== /Datos personales ====== -->

      <div class="form-row">
        <label for="categoria_id" class="form-label">Categoría</label>
        <select id="categoria_id" name="categoria_id" required class="form-select">
          <option value="" disabled selected>-- Elegí categoría --</option>
          {% for c in categorias %}
            <option value="{{ c.id }}">{{ c.nombre }} ({{ c.puntos_min }}–{{ c.puntos_max }})</option>
          {% endfor %}
        </select>
      </div>

      <div class="form-row">
        <label for="mensaje" class="form-label">Mensaje (opcional)</label>
        <input id="mensaje" name="mensaje" placeholder="Ej: juego los martes a la noche." class="form-input" autocomplete="off">
      </div>

      <div style="display:flex; gap:8px; flex-wrap:wrap; align-items:center; margin-top:4px;">
        <button id="btn-submit" type="submit" class="btn">Enviar solicitud</button>
        <a href="{{ url_for('login') }}" class="btn-ghost btn-slim">Cancelar</a>
      </div>

      <p class="help-note">
        Al enviar, aceptás que un administrador vea tus datos para validar el alta.
      </p>
    </form>
  </div>

  <!-- Bloque informativo -->
  <div class="card" style="border-style:dashed;">
    <h3 style="margin:0 0 6px;">¿Cómo sigue?</h3>
    <ol style="margin:0; padding-left:18px;">
      <li>Un admin revisa tu solicitud.</li>
      <li>Si todo está OK, te asignan un <strong>PIN</strong>.</li>
      <li>Entrás por <em>Iniciar sesión</em> (nombre + PIN) y vas a <strong>Mi panel</strong>.</li>
    </ol>
  </div>

</div>

<!-- JS: mayúsculas en nombre + sanitizar teléfono + provincias AR + límite fecha + evitar doble submit -->
<script>
  // Nombre en MAYÚSCULAS (mantiene acentos)
  const $nombre = document.getElementById('nombre_completo');
  if ($nombre){
    $nombre.addEventListener('input', () => {
      const pos = $nombre.selectionStart;
      $nombre.value = ($nombre.value || '').toUpperCase();
      try { $nombre.setSelectionRange(pos, pos); } catch(_){}
    }, { passive: true });
  }

  // Teléfono: permitir solo dígitos en tel_cc y tel_local
  const onlyDigits = (s) => (s || '').replace(/\D+/g, '');
  function sanitizeNumericInput(el, maxLen){
    if (!el) return;
    el.addEventListener('input', () => {
      const raw = el.value;
      const digits = onlyDigits(raw).slice(0, maxLen || 32);
      if (raw !== digits) el.value = digits;
    }, { passive: true });
  }
  const $cc = document.getElementById('tel_cc');
  const $local = document.getElementById('tel_local');
  sanitizeNumericInput($cc, 4);
  sanitizeNumericInput($local, 18);

  // Compat: mantener hidden "telefono" vacío
  const $compat = document.getElementById('telefono_compat');
  if ($compat) $compat.value = '';

  // Evitar doble submit
  (function(){
    const $form = document.querySelector('form[action="{{ url_for("alta_publica") }}"]');
    const $btn = document.getElementById('btn-submit');
    if ($form && $btn){
      $form.addEventListener('submit', () => {
        $btn.disabled = true;
        $btn.textContent = 'Enviando...';
      });
    }
  })();

  // ===== Provincias (Argentina) + límite de fecha de nacimiento =====
  (function(){
    const $pais = document.getElementById('pais');
    const $prov = document.getElementById('provincia');
    const $dob  = document.getElementById('fecha_nacimiento');

    const PROVINCIAS_AR = [
      "Buenos Aires","CABA","Catamarca","Chaco","Chubut","Córdoba","Corrientes",
      "Entre Ríos","Formosa","Jujuy","La Pampa","La Rioja","Mendoza","Misiones",
      "Neuquén","Río Negro","Salta","San Juan","San Luis","Santa Cruz",
      "Santa Fe","Santiago del Estero","Tierra del Fuego","Tucumán"
    ];

    function cargarProvincias(paisActual){
      if (!$prov) return;
      $prov.innerHTML = '<option value="">-- Seleccioná --</option>';
      if (paisActual === 'Argentina'){
        PROVINCIAS_AR.forEach(p => {
          const o = document.createElement('option');
          o.value = p; o.textContent = p;
          $prov.appendChild(o);
        });
      }
    }

    if ($pais) {
      cargarProvincias($pais.value);
      $pais.addEventListener('change', () => cargarProvincias($pais.value));
    }

    if ($dob){
      const hoy = new Date();
      const yyyy = hoy.getFullYear();
      const mm = String(hoy.getMonth() + 1).padStart(2,'0');
      const dd = String(hoy.getDate()).padStart(2,'0');
      $dob.max = `${yyyy}-${mm}-${dd}`;
      $dob.min = `1900-01-01`;
    }
  })();
</script>
{% endblock %}

{% block help_content %}
<style>
  /* ==== Ayuda consistente con index ==== */
  .help-container{ display:flex; justify-content:center; width:100%; }
  .help-wrap{
    width: min(800px, 90vw);
    margin: 0 auto;
    max-height: 62dvh; max-height: 62vh;
    overflow: auto; overscroll-behavior: contain; position: relative; background: transparent;
  }
  .help-head{
    position: sticky; top: 0; z-index: 2;
    display:flex; align-items:center; gap:6px;
    padding:6px 6px; margin-bottom:4px;
    background: var(--bg, rgba(10,12,20,.96));
    border-bottom:1px solid rgba(255,255,255,.06);
  }
  .help-title{ margin:0; font-size: clamp(.9rem, 2vw, 1rem); }
  .help-sub{   margin:0; color:var(--muted,#98a2b3); font-size: clamp(.76rem, 1.6vw, .86rem); }
  .help-grid{ display:grid; grid-template-columns: repeat(auto-fit, minmax(228px, 1fr)); gap:8px; }
  .help-card{ background: rgba(255,255,255,.04); border:1px solid rgba(255,255,255,.08); border-radius:10px; padding:6px; }
  .help-card h4{ display:flex; align-items:center; gap:6px; margin:0 0 4px; font-size: clamp(.86rem, 1.8vw, .94rem); }
  .help-card p, .help-card li{ margin:3px 0; font-size: clamp(.76rem, 1.5vw, .84rem); line-height:1.28; }
  .help-ul, .help-ol{ padding-left:16px; margin:4px 0; }
  .chip{ display:inline-block; padding:2px 6px; border-radius:999px; font-size:.74rem; border:1px solid #2a2f45; background:#1b2138; margin-right:6px;}
  .chip.ok{ background:#1b3b2a; border-color:#1a704d;}
  .chip.info{ background:#1b2f3b; border-color:#1a4d70;}
  .chip.warn{ background:#3b2f1b; border-color:#704d1a;}
  .help-visual{ display:flex; align-items:center; justify-content:center; background: rgba(255,255,255,.03);
    border:1px dashed rgba(255,255,255,.12); border-radius:10px; padding:6px;}
  @media (max-width:540px){
    .help-grid{ grid-template-columns: 1fr; }
    .help-card h4 svg{ display:none; }
  }
</style>

<div class="help-container">
  <div class="help-wrap">
    <div class="help-head">
      <h3 class="help-title">Solicitud de alta — ayuda rápida</h3>
      <p class="help-sub">Qué completar, qué pasa después y tips</p>
    </div>

    <div class="help-grid">
      <section class="help-card">
        <h4>
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
            <path d="M4 6h16M4 12h16M4 18h16" stroke="currentColor"/>
          </svg>
          ¿Qué es esta solicitud?
        </h4>
        <p>Pedís acceso a UPLAY. Un admin revisará tus datos y te dará ingreso con un <strong>PIN</strong>.</p>
        <div>
          <span class="chip info">Datos personales</span>
          <span class="chip ok">Validación</span>
          <span class="chip warn">Aprobación</span>
        </div>
      </section>

      <section class="help-card">
        <h4>
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
            <path d="M12 2v20M2 12h20" stroke="currentColor"/>
          </svg>
          Cómo completarlo
        </h4>
        <ul class="help-ul">
          <li><strong>Nombre completo</strong>: tal como querés figurar en ranking.</li>
          <li><strong>Email</strong> y <strong>Teléfono</strong> para contacto.</li>
          <li><strong>País</strong>, <strong>Provincia/Estado</strong>, <strong>Ciudad</strong>.</li>
          <li><strong>Fecha de nacimiento</strong> (opcional) para estadísticas/categorías.</li>
          <li><strong>Categoría</strong> según tu nivel. <em>Mensaje</em> con info útil.</li>
        </ul>
      </section>

      <section class="help-card">
        <h4>
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
            <path d="M6 6h12v12H6z" stroke="currentColor"/>
          </svg>
          ¿Qué pasa luego?
        </h4>
        <ol class="help-ol">
          <li>Un admin revisa tu solicitud.</li>
          <li>Si todo está OK, te asignan un <strong>PIN</strong>.</li>
          <li>Entrás por <em>Iniciar sesión</em> (nombre + PIN) y vas a <strong>Mi panel</strong>.</li>
        </ol>
      </section>

      <section class="help-card">
        <h4>
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
            <circle cx="12" cy="12" r="9" stroke="currentColor"/>
          </svg>
          Privacidad y cambios
        </h4>
        <ul class="help-ul">
          <li>Solo admins ven tu solicitud.</li>
          <li>Podés <strong>actualizar tu PIN</strong> luego desde <em>Editar jugador</em>.</li>
          <li>Si te equivocaste de categoría, un admin puede corregirla.</li>
        </ul>
      </section>

      <section class="help-card">
        <h4>
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
            <path d="M12 2l3 7h7l-5.5 4 2 7-6.5-4.5L5 20l2-7L1 9h7l4-7z" stroke="currentColor"/>
          </svg>
          Tips rápidos
        </h4>
        <ul class="help-ul">
          <li>Si no sabés tu categoría, indicá tu nivel aproximado en el mensaje.</li>
          <li>Dejá un teléfono que uses en WhatsApp para coordinar partidos.</li>
        </ul>
      </section>
    </div>
  </div>
</div>
{{ super() }}
{% endblock %}
