{% extends "base.html" %}
{% block title %}Solicitud de alta{% endblock %}

{% block content %}
<style>
  /* ===== Hero / cabecera ===== */
  .hero{
    position:relative; overflow:hidden;
    border-radius:16px; padding:14px;
    background:
      radial-gradient(700px 260px at 0% 0%, rgba(138,232,12,.25), transparent 60%),
      radial-gradient(700px 260px at 100% 100%, rgba(246,201,14,.18), transparent 60%),
      linear-gradient(180deg, rgba(0,0,0,.22), rgba(0,0,0,.10));
    border:1px solid rgba(255,255,255,.12);
    box-shadow:0 14px 40px rgba(0,0,0,.28);
    margin-bottom:12px;
  }
  .hero-top{ display:flex; gap:12px; align-items:flex-end; justify-content:space-between; flex-wrap:wrap; }
  .hero-title{ margin:0; font-family:"Poppins",system-ui; font-weight:800; letter-spacing:.3px; }
  .hero-tag{
    margin:0; text-transform:uppercase; font-weight:800; letter-spacing:.14em; line-height:1;
    font-size:clamp(.78rem, 1.6vw, .92rem);
    background: linear-gradient(90deg, var(--yellow), var(--neon));
    -webkit-background-clip:text; background-clip:text; color:transparent;
    filter: drop-shadow(0 0 .15em rgba(0,0,0,.25)); opacity:.95;
  }
  .hero-actions{display:flex; gap:10px; flex-wrap:wrap;}

  /* ===== Flash messages ===== */
  .flash-msg{
    border-radius:10px; padding:10px 14px; margin:8px 0;
    font-weight:600; text-align:center;
    display:flex; align-items:center; justify-content:center; gap:8px;
    animation:fadeIn .3s ease, fadeOut 6s ease forwards;
  }
  .flash-success{
    background:rgba(16,185,129,.12); border:1px solid rgba(16,185,129,.45); color:var(--neon);
  }
  .flash-error{
    background:rgba(239,68,68,.12); border:1px solid rgba(239,68,68,.45); color:#f87171;
  }
  .flash-msg svg{ flex-shrink:0; }
  @keyframes fadeIn{from{opacity:0;transform:translateY(-6px);}to{opacity:1;transform:none;}}
  @keyframes fadeOut{to{opacity:0;transform:translateY(-6px);} }

  /* ===== Layout general ===== */
  .page-wrap{ display:grid; gap:10px; margin-top:12px; grid-template-columns: minmax(280px, 1fr); }
  .card{ border-radius:14px; border:1px solid rgba(255,255,255,.12);
         background:linear-gradient(180deg, var(--panel), var(--panel-2)); padding:10px; }
  .card-form{ max-width:720px; }

  /* ===== Inputs ===== */
  .form-row{ display:block; }
  .form-label{ display:block; margin-bottom:4px; color:var(--muted); font-weight:600; }
  .form-input, .form-select{
    width:100%; border-radius:10px; padding:10px 12px;
    background:rgba(255,255,255,.06);
    border:1px solid rgba(255,255,255,.14); color:#fff; outline:none;
    transition:border-color .2s, box-shadow .2s;
  }
  .form-input:focus, .form-select:focus{
    border-color: rgba(16,185,129,.45);
    box-shadow: 0 0 0 3px rgba(16,185,129,.18);
  }
  .form-select{
    -webkit-appearance:none; appearance:none;
    padding-right:38px;
    background-image:url("data:image/svg+xml,%3Csvg width='20' height='20' viewBox='0 0 24 24' fill='none'%3E%3Cpath d='M6 9l6 6 6-6' stroke='%23FFF' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
    background-repeat:no-repeat; background-position:right 10px center; background-size:18px;
  }
  .form-select option{ color:#111; background:#fff; }
  .btn-slim{ height:36px; padding:6px 10px; border-radius:10px; font-weight:700; }
  .btn-ghost{ background:rgba(255,255,255,.10); border:1px solid rgba(255,255,255,.18); }
  .btn{ background:rgba(255,255,255,.95); color:#111; border:1px solid rgba(255,255,255,.95); border-radius:12px; font-weight:800; padding:10px 14px; transition:all .2s; }
  .btn:hover{ background:var(--yellow); border-color:var(--yellow); transform:scale(1.02); }
  .btn:focus{ outline:none; box-shadow:0 0 0 3px rgba(255,255,255,.35); }

  .help-note{ color:var(--muted); margin:6px 0 0; font-size:.92rem; }
</style>

<!-- ===== HERO ===== -->
<div class="hero">
  <div class="hero-top">
    <div>
      <h1 class="hero-title">UPLAY</h1>
      <p class="hero-tag">Solicitud de alta</p>
    </div>
    <div class="hero-actions">
      <a href="{{ url_for('login') }}" class="btn-ghost btn-slim">Volver a Iniciar sesión</a>
    </div>
  </div>
  <p class="muted" style="margin:10px 0 0;">Completá tus datos y un administrador aprobará tu acceso. Al aprobar, te enviaremos un <strong>PIN de 6 dígitos</strong> por email.</p>
</div>

<!-- ===== FLASH MESSAGES ===== -->
{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
  <div style="margin-top:10px;">
    {% for category, message in messages %}
      <div class="flash-msg flash-{{ category }}">
        {% if category == 'success' %}
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 13l4 4L19 7"/></svg>
        {% elif category == 'error' %}
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12"/></svg>
        {% endif %}
        <span>{{ message }}</span>
      </div>
    {% endfor %}
  </div>
  {% endif %}
{% endwith %}

<!-- ===== CONTENIDO ===== -->
<div class="page-wrap">
  <div class="card card-form">
    <form method="post" action="{{ url_for('alta_publica') }}" style="display:grid; gap:10px;" novalidate>
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

      <!-- Nombre completo -->
      <div class="form-row">
        <label for="nombre_completo" class="form-label">Nombre completo</label>
        <input id="nombre_completo" name="nombre_completo" required placeholder="EJ: JUAN PÉREZ" class="form-input" autocomplete="name" autofocus>
        <small class="muted">Se guardará en mayúsculas.</small>
      </div>

      <!-- Email -->
      <div class="form-row">
        <label for="email" class="form-label">Email</label>
        <input id="email" name="email" type="email" required placeholder="tucorreo@ejemplo.com" class="form-input" autocomplete="email">
        <small class="help-note">Asegurate de escribirlo bien: ahí te llegará el <strong>PIN</strong> cuando te aprueben.</small>
      </div>

      <!-- Teléfono -->
      <div class="form-row">
        <label class="form-label">Teléfono</label>
        <div style="display:flex; gap:8px; align-items:center;">
          <div style="min-width:110px;">
            <label for="tel_cc" class="form-label" style="margin:0; color:var(--muted)">País</label>
            <input id="tel_cc" name="tel_cc" type="text" inputmode="numeric" pattern="[0-9]{1,4}" maxlength="4" value="54"
                   class="form-input" style="width:90px;" aria-label="Código de país" placeholder="Ej: 54">
          </div>
          <div style="flex:1;">
            <input id="tel_local" name="tel_local" type="text" inputmode="numeric" pattern="[0-9]{7,15}" maxlength="18" required
                   placeholder="Ej: 11 12345678" class="form-input" autocomplete="tel-national">
          </div>
        </div>
        <small class="help-note">Ejemplo AR: País <strong>54</strong> y Local <strong>1112345678</strong> → se guarda como <code>+541112345678</code>.</small>
        <input type="hidden" name="telefono" id="telefono_compat" value="">
      </div>

      <!-- ===== Datos personales ===== -->
      <div class="form-row" style="margin-top:6px;">
        <label class="form-label" style="font-weight:800;">Datos personales</label>
        <div style="display:grid; gap:10px; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));">
          <div>
            <label for="pais" class="form-label">País</label>
            <select id="pais" name="pais" class="form-select">
              <option value="">-- Seleccioná --</option>
              <option value="Argentina" selected>Argentina</option>
              <option value="Brasil">Brasil</option>
              <option value="Chile">Chile</option>
              <option value="Uruguay">Uruguay</option>
              <option value="Paraguay">Paraguay</option>
              <option value="Otro">Otro</option>
            </select>
          </div>

          <div>
            <label for="provincia" class="form-label">Provincia / Estado</label>
            <select id="provincia" name="provincia" class="form-select">
              <option value="">-- Seleccioná --</option>
            </select>
            <small class="help-note">Si tu país no es Argentina, podés dejarlo vacío.</small>
          </div>

          <div>
            <label for="ciudad" class="form-label">Ciudad</label>
            <input id="ciudad" name="ciudad" type="text" placeholder="Ej: Viedma" class="form-input">
          </div>

          <div>
            <label for="fecha_nacimiento" class="form-label">Fecha de nacimiento</label>
            <input id="fecha_nacimiento" name="fecha_nacimiento" type="date" class="form-input">
            <small class="help-note">Usamos esta info para categorías y reportes (opcional).</small>
          </div>
        </div>
      </div>

      <!-- Categoría -->
      <div class="form-row">
        <label for="categoria_id" class="form-label">Categoría</label>
        <select id="categoria_id" name="categoria_id" required class="form-select">
          <option value="" disabled selected>-- Elegí categoría --</option>
          {% for c in categorias %}
            <option value="{{ c.id }}">{{ c.nombre }} ({{ c.puntos_min }}–{{ c.puntos_max }})</option>
          {% endfor %}
        </select>
      </div>

      <!-- Mensaje -->
      <div class="form-row">
        <label for="mensaje" class="form-label">Mensaje (opcional)</label>
        <input id="mensaje" name="mensaje" placeholder="Ej: juego los martes a la noche." class="form-input" autocomplete="off">
      </div>

      <!-- Preferencia de PIN -->
      <div class="form-row" style="display:flex; align-items:center; gap:8px;">
        <input id="prefiere_pin_email" name="prefiere_pin_email" type="checkbox" checked>
        <label for="prefiere_pin_email" class="form-label" style="margin:0;">Quiero recibir mi <strong>PIN por email</strong>.</label>
      </div>

      <div style="display:flex; gap:8px; flex-wrap:wrap; align-items:center; margin-top:4px;">
        <button id="btn-submit" type="submit" class="btn">Enviar solicitud</button>
        <a href="{{ url_for('login') }}" class="btn-ghost btn-slim">Cancelar</a>
      </div>

      <p class="help-note">Al enviar, aceptás que un administrador vea tus datos para validar el alta.</p>
    </form>
  </div>

  <!-- Bloque informativo -->
  <div class="card" style="border-style:dashed;">
    <h3 style="margin:0 0 6px;">¿Cómo sigue?</h3>
    <ol style="margin:0; padding-left:18px;">
      <li>Un admin revisa tu solicitud.</li>
      <li>Si todo está OK, te asignamos un <strong>PIN de 6 dígitos</strong>.</li>
      <li>Te llega por email y ya podés <em>Iniciar sesión</em>.</li>
    </ol>
  </div>
</div>

<!-- ===== JS ===== -->
<script>
  const onlyDigits = (s) => (s || '').replace(/\D+/g, '');
  const $nombre = document.getElementById('nombre_completo');
  if ($nombre){
    $nombre.addEventListener('input', () => {
      const pos = $nombre.selectionStart;
      $nombre.value = ($nombre.value || '').toUpperCase();
      try { $nombre.setSelectionRange(pos, pos); } catch(_){}
    });
  }

  const $email = document.getElementById('email');
  if ($email){
    $email.addEventListener('input', () => {
      $email.value = ($email.value || '').toLowerCase().trim();
    });
  }

  function sanitizeNumericInput(el, maxLen){
    if (!el) return;
    el.addEventListener('input', () => {
      el.value = onlyDigits(el.value).slice(0, maxLen || 32);
    });
  }
  sanitizeNumericInput(document.getElementById('tel_cc'), 4);
  sanitizeNumericInput(document.getElementById('tel_local'), 18);

  (function(){
    const $form = document.querySelector('form[action="{{ url_for("alta_publica") }}"]');
    const $btn = document.getElementById('btn-submit');
    if ($form && $btn){
      $form.addEventListener('submit', () => {
        $btn.disabled = true;
        $btn.textContent = 'Enviando...';
      });
    }
  })();

  (function(){
    const $pais = document.getElementById('pais');
    const $prov = document.getElementById('provincia');
    const $dob  = document.getElementById('fecha_nacimiento');
    const PROVINCIAS_AR = [
      "Buenos Aires","CABA","Catamarca","Chaco","Chubut","Córdoba","Corrientes",
      "Entre Ríos","Formosa","Jujuy","La Pampa","La Rioja","Mendoza","Misiones",
      "Neuquén","Río Negro","Salta","San Juan","San Luis","Santa Cruz",
      "Santa Fe","Santiago del Estero","Tierra del Fuego","Tucumán"
    ];
    function cargarProvincias(pais){
      if (!$prov) return;
      $prov.innerHTML = '<option value="">-- Seleccioná --</option>';
      if (pais === 'Argentina'){
        PROVINCIAS_AR.forEach(p => {
          const o = document.createElement('option');
          o.value = p; o.textContent = p;
          $prov.appendChild(o);
        });
      }
    }
    if ($pais){
      cargarProvincias($pais.value);
      $pais.addEventListener('change', () => cargarProvincias($pais.value));
    }
    if ($dob){
      const hoy = new Date();
      const yyyy = hoy.getFullYear(), mm = String(hoy.getMonth()+1).padStart(2,'0'), dd = String(hoy.getDate()).padStart(2,'0');
      $dob.max = `${yyyy}-${mm}-${dd}`;
      $dob.min = `1900-01-01`;
    }
  })();
</script>
{% endblock %}

{% block help_content %}
{{ super() }}
{% endblock %}
