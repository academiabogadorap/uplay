{% extends "base.html" %}
{% block title %}Partidos abiertos{% endblock %}

{% block content %}
  <h2 style="margin:6px 0 12px;">Partidos abiertos</h2>

  <!-- Crear -->
  <div class="card">
    <h3>Crear</h3>

    {% if current_jugador %}
      <!-- Crear partido abierto con la categoría del usuario logueado -->
      <form method="post" action="{{ url_for('abiertos_new') }}">
        <p class="muted" style="margin:0 0 10px;">
          Vas a crear un partido en
          <strong>{{ current_jugador.categoria.nombre if current_jugador.categoria else '-' }}</strong>.
        </p>

        <input type="hidden" name="categoria_id" value="{{ current_jugador.categoria_id }}">
        <input type="hidden" name="creador_id" value="{{ current_jugador.id }}">

        <label>Nota (opcional)</label>
        <input name="nota" placeholder="Ej: martes 20hs en Club X">

        <div style="margin-top:10px;">
          <button type="submit" class="btn">Crear partido</button>
        </div>
      </form>
    {% else %}
      <div class="flash-error">
        Iniciá sesión para crear un partido abierto en tu categoría.
        <a href="{{ url_for('login') }}" class="btn btn-ghost btn-slim" style="margin-left:8px;">Iniciar sesión</a>
      </div>
    {% endif %}
  </div>

  <!-- Listado -->
  <div class="card" style="margin-top:12px;">
    <div style="display:flex; align-items:center; justify-content:space-between; gap:8px;">
      <h3 style="margin:0;">Listado</h3>

      {# Toggle admin: ver todos vs solo activos (ABIERTO/LLENO) #}
      {% if current_jugador and current_jugador.is_admin %}
        {% set showing_all = (admin_wants_all|default(0) == 1) %}
        <div>
          {% if showing_all %}
            <span class="muted" style="margin-right:6px;">Mostrando: todos los estados</span>
            <a class="btn btn-ghost btn-slim" href="{{ url_for('abiertos_list') }}">Ver solo activos</a>
          {% else %}
            <span class="muted" style="margin-right:6px;">Mostrando: solo activos</span>
            <a class="btn btn-ghost btn-slim" href="{{ url_for('abiertos_list', all=1) }}">Ver todos</a>
          {% endif %}
        </div>
      {% endif %}
    </div>

    {% if abiertos and abiertos|length > 0 %}
      <table style="margin-top:8px;">
        <thead>
          <tr>
            <th>Categoría</th>
            <th>Creador</th>
            <th>Nota</th>
            <th>Inscriptos</th>
            <th>Estado</th>
            <th>Acciones</th>
            <th>Creado</th>
          </tr>
        </thead>
        <tbody>
          {% for pa in abiertos %}
            {% set cant_ins = pa.inscriptos|length if pa.inscriptos else 0 %}
            {% set sup_count = (suplentes_counts[pa.id] if suplentes_counts is defined and pa.id in suplentes_counts else 0) %}
            {% set ya_suplente = (mis_suplencias_pa_ids is defined and pa.id in mis_suplencias_pa_ids) %}
            <tr>
              <td>
                {{ pa.categoria.nombre if pa.categoria else '-' }}<br>
                <span class="badge">{{ cant_ins }}/4 jugadores</span>
              </td>
              <td>{{ pa.creador.nombre_completo if pa.creador else '-' }}</td>
              <td>{{ pa.nota or '—' }}</td>
              <td>
                {% if pa.inscriptos %}
                  {% for it in pa.inscriptos %}
                    {{ it.jugador.nombre_completo }}
                    {% if it.partner_pref %}
                      <span class="muted">(prefiere con {{ it.partner_pref.nombre_completo }})</span>
                    {% endif %}
                    {% if not loop.last %}, {% endif %}
                  {% endfor %}
                {% else %}
                  <span class="muted">—</span>
                {% endif %}
              </td>
              <td>
                <span class="badge {% if pa.estado=='ABIERTO' %}badge-ok{% elif pa.estado in ['LLENO','PARTIDO_CREADO'] %}badge-warn{% elif pa.estado=='CANCELADO' %}badge-danger{% endif %}">
                  {{ pa.estado }}
                </span>
                <div style="margin-top:4px;">
                  {# --- Tooltip con nombres de suplentes --- #}
                  {% set sup_names = [] %}
                  {% if pa.suplentes %}
                    {% for s in pa.suplentes %}
                      {% if s.jugador %}
                        {% set _ = sup_names.append(s.jugador.nombre_completo) %}
                      {% endif %}
                    {% endfor %}
                  {% endif %}
                  {% set sup_title = 'Suplentes: ' ~ (sup_names|join(', ') if sup_names else '—') %}
                  <span class="badge" title="{{ sup_title }}">Suplentes: {{ sup_count }}</span>
                </div>
              </td>
              <td style="min-width:280px;">
                {% if current_jugador and current_jugador.categoria_id == pa.categoria_id %}
                  {% set ya_esta = pa.inscriptos | selectattr('jugador_id', 'equalto', current_jugador.id) | list %}

                  {% if not ya_esta %}
                    {# --- Cálculo de elegibles realmente libres --- #}
                    {% set ya_elegidos = pa.inscriptos
                                          | selectattr('partner_pref')
                                          | map(attribute='partner_pref')
                                          | map(attribute='id')
                                          | list %}
                    {% set elegibles = [] %}
                    {% for it in pa.inscriptos %}
                      {% set id_j = it.jugador.id %}
                      {% set fue_elegido = id_j in ya_elegidos %}
                      {% set el_eligio_a_otro = it.partner_pref is not none %}
                      {% if id_j != current_jugador.id and (not fue_elegido) and (not el_eligio_a_otro) %}
                        {% set _ = elegibles.append(it.jugador) %}
                      {% endif %}
                    {% endfor %}

                    <!-- Unirse: incluye "Sin preferencia" como primera opción -->
                    {% if pa.estado == 'ABIERTO' and cant_ins < 4 %}
                      <form method="post" action="{{ url_for('abiertos_join', pa_id=pa.id) }}" style="display:inline-block;">
                        <input type="hidden" name="jugador_id" value="{{ current_jugador.id }}">
                        <select name="partner_pref_id">
                          <option value="" selected>Sin preferencia (cualquiera)</option>
                          {% for jug in elegibles %}
                            <option value="{{ jug.id }}">{{ jug.nombre_completo }}</option>
                          {% endfor %}
                        </select>
                        <button type="submit" class="btn btn-slim" style="margin-left:6px;">Unirme</button>
                      </form>
                    {% else %}
                      {# Lleno o no-ABIERTO: manejo de suplencias #}
                      {% if ya_suplente %}
                        <span class="badge badge-ok" style="margin-left:6px;">Ya sos suplente</span>
                        <form method="post"
                              action="{{ url_for('abiertos_suplente_quitar', pa_id=pa.id) }}"
                              style="display:inline-block; margin-left:6px;">
                          <button type="submit" class="btn btn-ghost btn-slim">Quitarme</button>
                        </form>
                      {% else %}
                        <form method="post"
                              action="{{ url_for('abiertos_suplente', pa_id=pa.id) }}"
                              style="display:inline-block;">
                          <button type="submit" class="btn btn-ghost btn-slim">Proponerme como suplente</button>
                        </form>
                      {% endif %}
                    {% endif %}
                  {% else %}
                    <!-- Salir (usa al jugador logueado) -->
                    <form method="post" action="{{ url_for('abiertos_leave', pa_id=pa.id) }}" style="display:inline-block;">
                      <input type="hidden" name="jugador_id" value="{{ current_jugador.id }}">
                      <button type="submit" class="btn btn-danger btn-slim">Salir</button>
                    </form>
                  {% endif %}
                {% else %}
                  <span class="muted">Iniciá sesión con un jugador de esta categoría para unirte.</span>
                {% endif %}

                {% if pa.inscriptos and cant_ins == 4 and pa.estado in ['ABIERTO','LLENO'] %}
                  <form method="post" action="{{ url_for('abiertos_armar', pa_id=pa.id) }}" style="display:inline-block; margin-left:6px;">
                    <button type="submit" class="btn btn-ok btn-slim">Armar partido</button>
                  </form>
                {% endif %}

                {# --- Cancelar (creador o admin) --- #}
                {% if current_jugador and (current_jugador.is_admin or current_jugador.id == pa.creador_id) %}
                  {% if pa.estado not in ['CANCELADO', 'PARTIDO_CREADO'] %}
                    <form method="post"
                          action="{{ url_for('abiertos_cancelar', pa_id=pa.id) }}"
                          style="display:inline-block; margin-left:6px;"
                          onsubmit="return confirm('¿Cancelar el abierto #{{ pa.id }}?');">
                      <button type="submit" class="btn btn-warning btn-slim">Cancelar</button>
                    </form>
                  {% elif pa.estado == 'CANCELADO' %}
                    <button type="button" disabled class="btn btn-ghost btn-slim" style="margin-left:6px; opacity:.6;">Cancelado</button>
                  {% endif %}
                {% endif %}

                {# --- Eliminar (solo admin) --- #}
                {% if current_jugador and current_jugador.is_admin %}
                  {% if pa.estado != 'PARTIDO_CREADO' %}
                    <form method="post"
                          action="{{ url_for('abiertos_eliminar', pa_id=pa.id) }}"
                          style="display:inline-block; margin-left:6px;"
                          onsubmit="return confirm('¿Eliminar el abierto #{{ pa.id }}? Esta acción no se puede deshacer.');">
                      <button type="submit" class="btn btn-danger btn-slim">Eliminar</button>
                    </form>
                  {% else %}
                    <button type="button" disabled title="Ya derivó en partido" class="btn btn-ghost btn-slim" style="margin-left:6px; opacity:.6;">Eliminar</button>
                  {% endif %}
                {% endif %}
              </td>
              <td class="muted">{{ pa.creado_en.strftime('%Y-%m-%d %H:%M') }}</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    {% else %}
      <p class="muted" style="margin-top:8px;">No hay partidos abiertos aún.</p>
    {% endif %}
  </div>
{% endblock %}

{% block help_content %}
<style>
  /* ==== Modal de ayuda compacto con scroll propio (alineado con index / jugadores / partidos / desafíos / categorías) ==== */
  .help-container{ display:flex; justify-content:center; width:100%; }
  .help-wrap{
    width: min(800px, 90vw);
    margin: 0 auto;

    /* Altura reducida + scroll único del contenido */
    max-height: 62dvh;   /* si el modal padre ocupa más, bajar a 60dvh/58dvh */
    max-height: 62vh;    /* fallback */
    overflow: auto;
    overscroll-behavior: contain;

    position: relative;
    background: transparent;
  }

  /* Encabezado sticky y compacto */
  .help-head{
    position: sticky; top: 0; z-index: 2;
    display:flex; align-items:center; gap:6px;
    padding:6px 6px; margin-bottom:4px;
    background: var(--bg, rgba(10,12,20,.96));
    border-bottom:1px solid rgba(255,255,255,.06);
  }
  .help-title{ margin:0; font-size: clamp(.92rem, 2vw, 1.02rem); }
  .help-sub{   margin:0; color:var(--muted,#98a2b3); font-size: clamp(.78rem, 1.7vw, .88rem); }

  /* Grid sin desbordes */
  .help-grid{
    display:grid;
    grid-template-columns: repeat(auto-fit, minmax(236px, 1fr));
    gap:8px;
  }

  /* Tarjetas y tipografías más chicas */
  .help-card{
    background: rgba(255,255,255,.04);
    border: 1px solid rgba(255,255,255,.08);
    border-radius:10px;
    padding:6px;
  }
  .help-card h4{
    display:flex; align-items:center; gap:6px;
    margin:0 0 4px;
    font-size: clamp(.88rem, 1.9vw, .96rem);
  }
  .help-card p, .help-card li{
    margin:3px 0;
    font-size: clamp(.78rem, 1.6vw, .86rem);
    line-height:1.3;
  }
  .help-ul, .help-ol{ padding-left:16px; margin:4px 0; }

  .help-badges { display:flex; gap:6px; flex-wrap:wrap; margin-top:4px; }
  .chip{ display:inline-block; padding:2px 7px; border-radius:999px; font-size:.76rem; border:1px solid #2a2f45; background:#1b2138;}
  .chip.ok{ background:#1b3b2a; border-color:#1a704d; }
  .chip.warn{ background:#3b2f1b; border-color:#704d1a; }
  .chip.danger{ background:#3b1b1b; border-color:#701a1a; }

  .help-actions{ display:flex; flex-wrap:wrap; gap:8px; margin-top:6px; }
  .help-actions a,.help-actions button{
    padding:6px 10px; border-radius:8px; border:1px solid rgba(255,255,255,.12);
    background: rgba(255,255,255,.04); color:inherit; text-decoration:none; font-size:.9rem;
  }
  .help-actions a:hover,.help-actions button:hover{ background: rgba(255,255,255,.08); }

  .help-visual{
    display:flex; align-items:center; justify-content:center;
    background: rgba(255,255,255,.03);
    border:1px dashed rgba(255,255,255,.12);
    border-radius:10px; padding:6px;
  }
  .help-visual svg, .help-card img{ max-width:100%; height:auto; display:block; }

  @media (max-width:540px){
    .help-grid{ grid-template-columns: 1fr; }
    .help-card h4 svg{ display:none; }
  }
</style>

<div class="help-container">
  <div class="help-wrap">
    <div class="help-head">
      <h3 class="help-title">¿Cómo funcionan los “Partidos abiertos”?</h3>
      <p class="help-sub">Guía rápida y visual</p>
    </div>

    <div class="help-grid">
      <!-- Qué es -->
      <section class="help-card">
        <h4>
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M12 3l9 4.5v9L12 21 3 16.5v-9L12 3z" stroke="currentColor" opacity=".9"/>
            <circle cx="12" cy="12" r="2" fill="currentColor" opacity=".9"/>
          </svg>
          ¿Qué es un partido abierto?
        </h4>
        <p>Una invitación pública dentro de tu <strong>categoría</strong> para completar 4 jugadores y luego armar un partido.</p>
        <div class="help-badges">
          <span class="chip ok">ABIERTO</span>
          <span class="chip warn">LLENO</span>
          <span class="chip warn">PARTIDO_CREADO</span>
          <span class="chip danger">CANCELADO</span>
        </div>
      </section>

      <!-- Crear -->
      <section class="help-card">
        <h4>
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M12 2v20M2 12h20" stroke="currentColor"/></svg>
          Crear
        </h4>
        <ul class="help-ul">
          <li>El partido se crea en tu <strong>categoría</strong> actual.</li>
          <li>Podés agregar una <em>nota</em> (“martes 20hs en Club X”).</li>
          <li>Quedará visible para que otros se inscriban.</li>
        </ul>
        <div class="help-actions">
          <a href="{{ url_for('abiertos_new') }}">➕ Crear partido</a>
        </div>
      </section>

      <!-- Unirse + preferencia -->
      <section class="help-card">
        <h4>
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M4 12h6l2-3 2 6 2-3h4" stroke="currentColor"/></svg>
          Unirse y elegir compañero
        </h4>
        <ul class="help-ul">
          <li>Solo si estás en la <strong>misma categoría</strong> del abierto.</li>
          <li>Podés unirte con <em>Sin preferencia</em> o elegir a alguien libre.</li>
          <li>Un jugador está “no disponible” si ya eligió a otro o si otro lo eligió.</li>
          <li>Si ya estás anotado, podés <strong>Salir</strong>.</li>
        </ul>
      </section>

      <!-- Suplentes -->
      <section class="help-card">
        <h4>
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M8 12h8M12 8v8" stroke="currentColor"/></svg>
          Suplentes
        </h4>
        <ul class="help-ul">
          <li>Si el abierto está <em>LLENO</em> o no hay cupos, podés <strong>proponerte</strong> como suplente.</li>
          <li>Podés <strong>quitarte</strong> de suplente cuando quieras.</li>
          <li>El contador muestra cuántos suplentes hay; pasá el mouse para ver nombres.</li>
        </ul>
      </section>

      <!-- Armar / Cancelar / Eliminar -->
      <section class="help-card">
        <h4>
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M6 6h12v12H6z" stroke="currentColor"/></svg>
          Armar y administrar
        </h4>
        <ul class="help-ul">
          <li>Con <strong>4 inscriptos</strong> y estado <em>ABIERTO</em>/<em>LLENO</em> aparece <strong>Armar partido</strong>.</li>
          <li><strong>Creador/Admin</strong> pueden <strong>Cancelar</strong> salvo que ya esté <em>PARTIDO_CREADO</em>.</li>
          <li><strong>Admin</strong> puede <strong>Eliminar</strong> (si no derivó en partido).</li>
        </ul>
      </section>

      <!-- Ejemplo visual -->
      <section class="help-card">
        <h4>
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><circle cx="12" cy="12" r="9" stroke="currentColor"/></svg>
          Ejemplo visual
        </h4>
        <div class="help-visual">
          <svg width="260" height="110" viewBox="0 0 280 120" aria-hidden="true">
            <rect x="1" y="1" width="278" height="118" rx="10" fill="#0f172a" stroke="rgba(255,255,255,.12)"/>
            <!-- Slots jugadores -->
            <circle cx="60" cy="40" r="12" fill="#22c55e"/><text x="60" y="65" fill="#9aa3b2" font-size="10" text-anchor="middle">1</text>
            <circle cx="110" cy="40" r="12" fill="#22c55e80"/><text x="110" y="65" fill="#9aa3b2" font-size="10" text-anchor="middle">2</text>
            <circle cx="170" cy="40" r="12" fill="#64748b40"/><text x="170" y="65" fill="#9aa3b2" font-size="10" text-anchor="middle">3</text>
            <circle cx="220" cy="40" r="12" fill="#64748b40"/><text x="220" y="65" fill="#9aa3b2" font-size="10" text-anchor="middle">4</text>
            <!-- Chips -->
            <rect x="12" y="8" rx="6" ry="6" width="64" height="18" fill="#1b3b2a"/><text x="44" y="21" fill="#fff" font-size="10" text-anchor="middle">ABIERTO</text>
            <rect x="84" y="8" rx="6" ry="6" width="56" height="18" fill="#3b2f1b"/><text x="112" y="21" fill="#fff" font-size="10" text-anchor="middle">LLENO</text>
            <rect x="144" y="8" rx="6" ry="6" width="110" height="18" fill="#3b2f1b"/><text x="199" y="21" fill="#fff" font-size="10" text-anchor="middle">PARTIDO_CREADO</text>
          </svg>
        </div>
        <p class="muted" style="margin-top:4px;">Verde: lugares ocupados · Gris: cupos libres · Chips: estado</p>
      </section>

      <!-- Tips rápidos -->
      <section class="help-card">
        <h4>
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M12 2l3 7h7l-5.5 4 2 7-6.5-4.5L5 20l2-7L1 9h7l4-7z" stroke="currentColor"/></svg>
          Tips rápidos
        </h4>
        <ul class="help-ul">
          <li>¿No ves “Unirme”? Debés estar logueado y en la misma categoría.</li>
          <li>Si no hay cupo, anotate como <strong>suplente</strong>.</li>
          <li>Para armar, esperá a que sean 4 inscriptos.</li>
        </ul>
        <div class="help-actions">
          <a href="{{ url_for('mi_panel') }}">🏠 Mi Panel</a>
        </div>
      </section>
    </div>
  </div>
</div>
{% endblock %}
