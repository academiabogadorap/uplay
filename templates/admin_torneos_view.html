{% extends "base.html" %}
{% block title %}Torneo: {{ t.nombre }}{% endblock %}

{% block content %}
<style>
  /* ====== HERO (match con /mi) ====== */
  .hero{
    position:relative; overflow:hidden; border-radius:16px; padding:14px;
    background:
      radial-gradient(700px 260px at 0% 0%, rgba(138,232,12,.25), transparent 60%),
      radial-gradient(700px 260px at 100% 100%, rgba(246,201,14,.18), transparent 60%),
      linear-gradient(180deg, rgba(0,0,0,.22), rgba(0,0,0,.10));
    border:1px solid rgba(255,255,255,.12); box-shadow:0 14px 40px rgba(0,0,0,.28);
    margin-bottom:10px;
  }
  .hero-top{ display:flex; gap:12px; align-items:flex-end; justify-content:space-between; flex-wrap:wrap; }
  .hero-title{ margin:0; font-family:"Poppins",system-ui; font-weight:800; letter-spacing:.3px; }
  .chips{display:flex; gap:8px; flex-wrap:wrap; margin-top:10px;}
  .chip{ display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px;
         background:rgba(255,255,255,.10); border:1px solid rgba(255,255,255,.16); font-weight:700; }
  .dot{width:8px; height:8px; border-radius:50%;}
  .dot.g{ background:var(--neon); } .dot.y{ background:var(--yellow); } .dot.b{ background:#6EA8FF; }

  /* ===== Badges ===== */
  .badge{ display:inline-block; padding:3px 9px; border-radius:999px; font-size:.8rem;
          border:1px solid rgba(255,255,255,.16); background:rgba(255,255,255,.08); color:#e6edf3; }
  .state-BORRADOR{ background:#2a2431; border-color:#5a4678; color:#e9d7ff; }
  .state-CANCELADO{ background:#3b1b1b; border-color:#701a1a; color:#ffe1e1; }
  .state-INSCRIPCION{ background:#1b2f3b; border-color:#1a4d70; color:#d6eaff; }
  .state-INSCRIPCION_CERRADA{ background:#3b2f1b; border-color:#704d1a; color:#ffecc7; }
  .state-EN_JUEGO{ background:#1b3b2a; border-color:#1a704d; color:#d7ffe9; }
  .state-FINALIZADO{ background:#212121; border-color:#464646; color:#e6e6e6; }

  /* ===== Botones ===== */
  .btn{ cursor:pointer; }
  .btn-slim{ height:36px; padding:6px 10px; border-radius:10px; font-weight:700; }
  .btn-ghost{ background:rgba(255,255,255,.10); border:1px solid rgba(255,255,255,.18); }

  /* ===== Tabla de posiciones ===== */
  .zona-card{ border-radius:12px; border:1px solid rgba(255,255,255,.12); background:rgba(255,255,255,.04); padding:10px; margin-top:10px; }
  .zona-header{ display:flex; justify-content:space-between; align-items:center; margin-bottom:6px; }
  table.posiciones{ width:100%; border-collapse:collapse; margin-top:6px; }
  table.posiciones th, table.posiciones td{ padding:6px 8px; border-bottom:1px solid rgba(255,255,255,.08); text-align:center; font-size:.9rem; }
  table.posiciones th{ color:var(--muted,#9fb3c8); font-weight:700; background:rgba(255,255,255,.03); }
  table.posiciones td:first-child{ text-align:left; }
  table.posiciones tr:first-child td{ border-top:1px solid rgba(255,255,255,.08); }
  .muted{ color:var(--muted,#9fb3c8); }
  .mini{ font-size:.86rem; }
</style>

<!-- ===== HERO ===== -->
<div class="hero">
  <div class="hero-top">
    <div>
      <h2 class="hero-title">{{ t.nombre }}</h2>
      <div class="chips">
        <span class="chip"><span class="dot b"></span> Estado: <span class="badge state-{{ t.estado }}">{{ t.estado }}</span></span>
        {% set raw_mod = (t.modalidad or t.formato or '') %}
        {% set mod_up = raw_mod.upper() %}
        <span class="chip"><span class="dot g"></span> {{ 'INDIVIDUAL' if mod_up == 'SINGLES' else 'PAREJAS' if mod_up == 'DOBLES' else (raw_mod or 'Modalidad -') }}</span>
        {% set tipo_up = (t.tipo or '')|upper %}
        <span class="chip"><span class="dot y"></span> {{ 'AMERICANO' if tipo_up == 'AMERICANO'
              else 'ZONAS + PLAYOFF' if tipo_up in ['ZONAS+PLAYOFF','ZONAS + PLAYOFF']
              else 'PLAYOFF' if tipo_up == 'PLAYOFF'
              else (t.tipo or 'Formato -') }}</span>
      </div>
    </div>
    <div class="hero-actions" style="display:flex; gap:8px; flex-wrap:wrap;">
      <a href="{{ url_for('admin_torneos_list') }}" class="btn btn-ghost btn-slim">Volver</a>
      <a href="{{ url_for('torneo_public_detail', torneo_id=t.id) }}" class="btn btn-ghost btn-slim">Ver p√°gina p√∫blica</a>
    </div>
  </div>
</div>

<!-- INFO -->
<div class="card torneo-info">
  <div class="info-grid">
    <div class="info-item"><strong>Modalidad</strong><span>{{ t.modalidad or '-' }}</span></div>
    <div class="info-item"><strong>Formato</strong><span>{{ t.tipo or '-' }}</span></div>
    <div class="info-item"><strong>Categor√≠a</strong><span>{{ t.categoria.nombre if t.categoria else '-' }}</span></div>
    <div class="info-item"><strong>Inicio</strong><span>{{ t.fecha_inicio or '-' }}</span></div>
    <div class="info-item"><strong>Sede</strong><span>{{ t.sede or '-' }}</span></div>
    <div class="info-item"><strong>Cupo m√°ximo</strong><span>{{ t.cupo_max or 'Sin l√≠mite' }}</span></div>
  </div>
  {% if t.notas %}<div class="notes"><em>{{ t.notas }}</em></div>{% endif %}
</div>

<!-- ACCIONES -->
<div class="card actions">
  <div class="actions-row">
    {% if t.estado in ('INSCRIPCION_CERRADA','EN_JUEGO') %}
      <form method="post" action="{{ url_for('admin_torneos_generar_fixture', tid=t.id) }}" class="seg">
        {% if csrf_token is defined %}<input type="hidden" name="csrf_token" value="{{ csrf_token() }}">{% endif %}
        <label for="modo">Modo</label>
        <select name="modo" id="modo">
          <option value="AMERICANO">Americano</option>
          <option value="ROUND_ROBIN">Round Robin (por zonas)</option>
          <option value="ZONAS_LLAVE">Zonas (1v2 / 3v4 ‚Üí Ganadores y Perdedores)</option>
          <option value="PLAYOFF">Playoff</option>
          <option value="PLAYOFF_NEXT">Siguiente ronda</option>
        </select>
        <label for="zonas">Zonas</label>
        <select name="zonas" id="zonas">
          {% for z in range(1, 17) %}
            <option value="{{ z }}" {{ 'selected' if z == 1 else '' }}>{{ z }}</option>
          {% endfor %}
        </select>
        <div id="grupo-roundrobin" style="display:none;">
          <label for="parejas_por_zona">Parejas por zona</label>
          <select name="parejas_por_zona" id="parejas_por_zona">
            {% for n in range(2, 9) %}
              <option value="{{ n }}" {{ 'selected' if n == 4 else '' }}>{{ n }}</option>
            {% endfor %}
          </select>
        </div>
        <button type="submit" class="btn btn-slim">Generar fixture</button>
      </form>

      <form method="post" action="{{ url_for('admin_torneos_generar_playoff_desde_zonas', tid=t.id) }}" class="seg">
        {% if csrf_token is defined %}<input type="hidden" name="csrf_token" value="{{ csrf_token() }}">{% endif %}
        <button type="submit" class="btn btn-ghost btn-slim">Generar Playoff desde Zonas</button>
      </form>
    {% endif %}
  </div>
</div>

<!-- PARTIDOS -->
<div class="card section">
  <h3>Partidos y resultados</h3>
  {% if partidos %}
    <table class="table">
      <thead><tr><th>#</th><th>Ronda</th><th>Partido</th><th>Estado</th></tr></thead>
      <tbody>
        {% for p in partidos %}
          <tr>
            <td>{{ p.id }}</td>
            <td>{{ p.ronda }}</td>
            <td>{{ p.participante_a_id }} vs {{ p.participante_b_id }}</td>
            <td>{{ p.estado }}</td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  {% else %}
    <p class="muted">No hay partidos generados todav√≠a.</p>
  {% endif %}
</div>

<!-- üî• NUEVA SECCI√ìN: TABLAS DE POSICIONES POR ZONA -->
{% if tablas_zonas %}
  <div class="card section">
    <h3>Tabla de posiciones por zonas</h3>
    {% for zona, tabla in tablas_zonas.items() %}
      <div class="zona-card">
        <div class="zona-header">
          <h4>Zona {{ zona }}</h4>
          <span class="muted">{{ tabla|length }} parejas</span>
        </div>
        <table class="posiciones">
          <thead>
            <tr>
              <th>Pareja</th><th>PJ</th><th>PG</th><th>PP</th><th>Sets+</th><th>Sets‚àí</th><th>Dif</th><th>Pts</th>
            </tr>
          </thead>
          <tbody>
            {% for fila in tabla %}
              <tr>
                <td>{{ fila.nombre }}</td>
                <td>{{ fila.pj }}</td>
                <td>{{ fila.pg }}</td>
                <td>{{ fila.pp }}</td>
                <td>{{ fila.sets_ganados }}</td>
                <td>{{ fila.sets_perdidos }}</td>
                <td>{{ fila.dif_sets }}</td>
                <td><strong>{{ fila.puntos }}</strong></td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% endfor %}
  </div>
{% endif %}

<script>
  const modoSelect = document.getElementById('modo');
  const grupoRoundRobin = document.getElementById('grupo-roundrobin');
  function actualizarVisibilidad() {
    if (modoSelect.value === 'ROUND_ROBIN' || modoSelect.value === 'ZONAS_LLAVE') {
      grupoRoundRobin.style.display = 'flex';
    } else {
      grupoRoundRobin.style.display = 'none';
    }
  }
  modoSelect.addEventListener('change', actualizarVisibilidad);
  actualizarVisibilidad();
</script>

{% endblock %}
