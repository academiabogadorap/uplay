{% extends "base.html" %}
{% block title %}Torneo: {{ t.nombre }}{% endblock %}

{% block content %}
<style>
  /* ====== HERO (match con /mi) ====== */
  .hero{
    position:relative; overflow:hidden; border-radius:16px; padding:14px;
    background:
      radial-gradient(700px 260px at 0% 0%, rgba(138,232,12,.25), transparent 60%),
      radial-gradient(700px 260px at 100% 100%, rgba(246,201,14,.18), transparent 60%),
      linear-gradient(180deg, rgba(0,0,0,.22), rgba(0,0,0,.10));
    border:1px solid rgba(255,255,255,.12); box-shadow:0 14px 40px rgba(0,0,0,.28);
    margin-bottom:10px;
  }
  .hero-top{ display:flex; gap:12px; align-items:flex-end; justify-content:space-between; flex-wrap:wrap; }
  .hero-title{ margin:0; font-family:"Poppins",system-ui; font-weight:800; letter-spacing:.3px; }
  .chips{display:flex; gap:8px; flex-wrap:wrap; margin-top:10px;}
  .chip{ display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px;
         background:rgba(255,255,255,.10); border:1px solid rgba(255,255,255,.16); font-weight:700; }
  .dot{width:8px; height:8px; border-radius:50%;}
  .dot.g{ background:var(--neon); } .dot.y{ background:var(--yellow); } .dot.b{ background:#6EA8FF; }

  /* ===== Badges de estado ===== */
  .badge{ display:inline-block; padding:3px 9px; border-radius:999px; font-size:.8rem;
          border:1px solid rgba(255,255,255,.16); background:rgba(255,255,255,.08); color:#e6edf3; }
  .state-BORRADOR{ background:#2a2431; border-color:#5a4678; color:#e9d7ff; }
  .state-CANCELADO{ background:#3b1b1b; border-color:#701a1a; color:#ffe1e1; }
  .state-INSCRIPCION{ background:#1b2f3b; border-color:#1a4d70; color:#d6eaff; }
  .state-INSCRIPCION_CERRADA{ background:#3b2f1b; border-color:#704d1a; color:#ffecc7; }
  .state-EN_JUEGO{ background:#1b3b2a; border-color:#1a704d; color:#d7ffe9; }
  .state-FINALIZADO{ background:#212121; border-color:#464646; color:#e6e6e6; }

  /* ===== Botones y pills ===== */
  .btn{ cursor:pointer; }
  .btn-slim{ height:36px; padding:6px 10px; border-radius:10px; font-weight:700; }
  .btn-ghost{ background:rgba(255,255,255,.10); border:1px solid rgba(255,255,255,.18); }
  .btn-danger{ background:#3b1b1b; border:1px solid #701a1a; }
  .pill{
    display:inline-flex; align-items:center; gap:6px; padding:6px 8px; border-radius:999px;
    background:rgba(255,255,255,.10); border:1px solid rgba(255,255,255,.18);
    font-size:.86rem; color:#e6edf3;
  }
  .pill *{ color:inherit; }

  /* ===== Cards / info ===== */
  .torneo-info.card{ padding:10px 12px; }
  .info-grid{
    display:grid;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    gap:8px;
    margin-top:6px;
  }
  .info-item{ background:rgba(255,255,255,.04); border:1px solid rgba(255,255,255,.08); border-radius:10px; padding:8px; }
  .info-item strong{ display:block; font-weight:800; font-size:.86rem; color:#cfe1ff; }
  .info-item span{ display:block; margin-top:2px; }
  .notes{
    margin-top:8px; padding:8px; border-radius:10px;
    background: rgba(255,255,255,.03); border:1px dashed rgba(255,255,255,.14);
    color:var(--muted,#9fb3c8);
    white-space:pre-wrap;
  }

  /* ===== Acciones ===== */
  .actions.card{ padding:10px; }
  .actions-row{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
  .seg{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
  .seg label{ font-weight:700; color:var(--muted,#9fb3c8); font-size:.9rem; }
  .seg select{
    height:36px; padding:6px 8px; border-radius:10px;
    background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.16); color:var(--text);
    max-width:220px;
  }
  .spacer{ flex:1; }

  /* ===== Tabla de partidos ===== */
  .card.section{ padding:10px 12px; margin-top:12px; }
  .section h3{ margin:0 0 8px; font-size:1.05rem; }
  .table{ width:100%; border-collapse:collapse; }
  .table th, .table td{
    padding:8px; border-bottom:1px solid rgba(255,255,255,.08); vertical-align:top;
  }
  .table th{ text-align:left; font-size:.85rem; color:var(--muted,#9fb3c8); font-weight:700; }
  .muted{ color:var(--muted,#9fb3c8); }
  .mini{ font-size:.86rem; }
  .nowrap{ white-space:nowrap; }
  .row-actions{ display:flex; gap:6px; flex-wrap:wrap; }
  .edit-form{ display:none; padding:8px; margin-top:6px; border-radius:8px;
    background:rgba(255,255,255,.05); border:1px solid rgba(255,255,255,.12);
  }
  .edit-form .field{ display:flex; gap:8px; align-items:center; margin:4px 0; flex-wrap:wrap; }
  .chip{ display:inline-block; padding:2px 8px; border-radius:999px; background:rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.16); }
  .winner{ color:#b7ffcf; font-weight:700; }
  .loser{ color:#ffb7b7; }
  @media (max-width:700px){
    .hide-sm{ display:none; }
  }
</style>

<!-- ===== HERO ===== -->
<div class="hero">
  <div class="hero-top">
    <div>
      <h2 class="hero-title">{{ t.nombre }}</h2>
      <div class="chips">
        <span class="chip"><span class="dot b"></span> Estado: <span class="badge state-{{ t.estado }}" style="margin-left:6px;">{{ t.estado }}</span></span>
        {% set raw_mod = (t.modalidad or t.formato or '') %}
        {% set mod_up = raw_mod.upper() %}
        <span class="chip"><span class="dot g"></span> {{ 'INDIVIDUAL' if mod_up == 'SINGLES' else 'PAREJAS' if mod_up == 'DOBLES' else (raw_mod or 'Modalidad -') }}</span>
        {% set tipo_up = (t.tipo or '')|upper %}
        <span class="chip"><span class="dot y"></span> {{ 'AMERICANO' if tipo_up == 'AMERICANO'
              else 'ZONAS + PLAYOFF' if tipo_up in ['ZONAS+PLAYOFF','ZONAS + PLAYOFF']
              else 'PLAYOFF' if tipo_up == 'PLAYOFF'
              else (t.tipo or 'Formato -') }}</span>
        {% if t.categoria %}
          <span class="chip"><span class="dot b"></span> Cat: {{ t.categoria.nombre }}</span>
        {% endif %}
        {% if t.fecha_inicio %}
          <span class="chip"><span class="dot g"></span> Inicio: {{ t.fecha_inicio }}</span>
        {% endif %}
      </div>
    </div>
    <div class="hero-actions" style="display:flex; gap:8px; flex-wrap:wrap;">
      <a href="{{ url_for('admin_torneos_list') }}" class="btn btn-ghost btn-slim">Volver</a>
      <a href="{{ url_for('torneo_public_detail', torneo_id=t.id) }}" class="btn btn-ghost btn-slim">Ver p√°gina p√∫blica</a>
    </div>
  </div>
</div>

<!-- ===== Info del Torneo ===== -->
<div class="card torneo-info">
  <div class="info-grid" role="list">
    <div class="info-item"><strong>Modalidad</strong><span>{{ t.modalidad or '-' }}</span></div>
    <div class="info-item"><strong>Formato</strong><span>{{ t.tipo or '-' }}</span></div>
    <div class="info-item"><strong>Categor√≠a</strong><span>{{ t.categoria.nombre if t.categoria else '-' }}</span></div>
    <div class="info-item"><strong>Inicio</strong><span>{{ t.fecha_inicio or '-' }}</span></div>
    <div class="info-item"><strong>Sede</strong><span>{{ t.sede or '-' }}</span></div>
    <div class="info-item"><strong>Cupo m√°ximo</strong><span>{{ t.cupo_max or 'Sin l√≠mite' }}</span></div>
  </div>
  {% if t.notas %}<div class="notes"><em>{{ t.notas }}</em></div>{% endif %}
</div>

<!-- ===== Acciones ===== -->
<div class="card actions" style="margin-top:10px;">
  <div class="actions-row">
    {% if t.estado in ('BORRADOR','CANCELADO') %}
      <form method="post" action="{{ url_for('admin_torneo_abrir_inscripcion', tid=t.id) }}">
        {% if csrf_token is defined %}<input type="hidden" name="csrf_token" value="{{ csrf_token() }}">{% endif %}
        <button type="submit" class="btn btn-slim">Abrir inscripci√≥n</button>
      </form>
      <span class="pill">Generar fixture (bloqueado)</span>

    {% elif t.estado == 'INSCRIPCION' %}
      <form method="post" action="{{ url_for('admin_torneo_cerrar_inscripcion', tid=t.id) }}">
        {% if csrf_token is defined %}<input type="hidden" name="csrf_token" value="{{ csrf_token() }}">{% endif %}
        <button type="submit" class="btn btn-ghost btn-slim">Cerrar inscripci√≥n</button>
      </form>
      <span class="pill">Generar fixture (bloqueado)</span>

    {% elif t.estado in ('INSCRIPCION_CERRADA', 'EN_JUEGO') %}
      {% if t.estado == 'INSCRIPCION_CERRADA' %}
        <span class="pill">Inscripci√≥n cerrada</span>
      {% else %}
        <span class="pill">Fixture en juego</span>
      {% endif %}

      <form method="post" action="{{ url_for('admin_torneos_generar_fixture', tid=t.id) }}" class="seg">
        {% if csrf_token is defined %}<input type="hidden" name="csrf_token" value="{{ csrf_token() }}">{% endif %}
        <label for="modo">Modo</label>
        <select name="modo" id="modo">
          <option value="AMERICANO">Americano (liga completa)</option>
          <option value="ROUND_ROBIN">Round Robin (por zonas)</option>
          <option value="ZONAS_LLAVE">Zonas (1v2 / 3v4 ‚Üí Ganadores y Perdedores)</option>
          <option value="PLAYOFF">Playoff (crear 1¬™ ronda)</option>
          <option value="PLAYOFF_NEXT">Siguiente ronda de Playoff</option>
        </select>

        <label for="zonas">Zonas</label>
        <select name="zonas" id="zonas">
          {% for z in range(1, 17) %}
            <option value="{{ z }}" {{ 'selected' if z == 1 else '' }}>{{ z }}</option>
          {% endfor %}
        </select>

        <div id="grupo-roundrobin" style="display:none;">
          <label for="parejas_por_zona">Parejas por zona</label>
          <select name="parejas_por_zona" id="parejas_por_zona">
            {% for n in range(2, 9) %}
              <option value="{{ n }}" {{ 'selected' if n == 4 else '' }}>{{ n }}</option>
            {% endfor %}
          </select>
        </div>

        <label for="ida_y_vuelta">Ida y vuelta</label>
        <select name="ida_y_vuelta" id="ida_y_vuelta">
          <option value="0" selected>No</option>
          <option value="1">S√≠</option>
        </select>

        <button type="submit" class="btn btn-slim">Generar fixture</button>
      </form>

      <!-- üî• Nuevo bot√≥n para crear Playoff desde Zonas -->
      <form method="post" action="{{ url_for('admin_torneos_generar_playoff_desde_zonas', tid=t.id) }}" class="seg">
        {% if csrf_token is defined %}<input type="hidden" name="csrf_token" value="{{ csrf_token() }}">{% endif %}
        <button type="submit" class="btn btn-ghost btn-slim">Generar Playoff desde Zonas</button>
      </form>

    {% elif t.estado == 'FINALIZADO' %}
      <span class="pill">Torneo finalizado</span>
    {% endif %}
  </div>
</div>

<!-- PARTIDOS -->
<div class="card section">
  <h3>Partidos y resultados</h3>
  {% if partidos and partidos|length > 0 %}
    <table class="table">
      <thead>
        <tr><th>#</th><th>Ronda</th><th>Partido</th><th>Estado</th><th>Resultado</th></tr>
      </thead>
      <tbody>
        {% for p in partidos %}
          <tr>
            <td>{{ p.id }}</td>
            <td>{{ p.ronda }}</td>
            <td>{{ p.participante_a_id }} vs {{ p.participante_b_id }}</td>
            <td>{{ p.estado }}</td>
            <td>{{ resultados[p.id].sets_text if resultados and p.id in resultados else '-' }}</td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  {% else %}
    <p class="muted">No hay partidos generados todav√≠a.</p>
  {% endif %}
</div>

<script>
  const modoSelect = document.getElementById('modo');
  const grupoRoundRobin = document.getElementById('grupo-roundrobin');
  function actualizarVisibilidad() {
    if (modoSelect.value === 'ROUND_ROBIN' || modoSelect.value === 'ZONAS_LLAVE') {
      grupoRoundRobin.style.display = 'flex';
    } else {
      grupoRoundRobin.style.display = 'none';
    }
  }
  modoSelect.addEventListener('change', actualizarVisibilidad);
  actualizarVisibilidad();
</script>

{% endblock %}
