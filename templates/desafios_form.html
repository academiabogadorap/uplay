{% extends "base.html" %}
{% block title %}Nuevo desafío · UPLAY{% endblock %}

{% block content %}
  <div style="display:flex; align-items:center; gap:10px; margin-bottom:8px;">
    <h2 style="margin:0;">Nuevo desafío</h2>
    <span class="muted" style="font-size:.95rem;">(inter-nivel, individual)</span>
  </div>

  <div class="card" style="max-width:900px;">
    <!-- Banner / ilustración -->
    <div style="display:flex; align-items:center; gap:14px; margin-bottom:10px;">
      <div style="flex:1; min-width:220px;">
        <p style="margin:0;">
          <strong>Desafiante:</strong> {{ desafiante.nombre_completo }}
          {% if desafiante.categoria %}
            — Categoría: <strong>{{ desafiante.categoria.nombre }}</strong>
          {% endif %}
          {% if cat_superior_nombre %}
            — Rivalizar contra: <strong>{{ cat_superior_nombre }}</strong>
          {% endif %}
        </p>
        <p class="muted" style="margin:.35rem 0 0;">Elegí un compañero de tu nivel (en zona de ascenso) y dos rivales del nivel superior.</p>
      </div>

      <!-- SVG decorativo (ligero, sin dependencias) -->
      <svg width="140" height="74" viewBox="0 0 280 148" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"
           style="flex:0 0 auto; filter:drop-shadow(0 6px 16px rgba(0,0,0,.35)); border-radius:12px; background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.0));">
        <rect x="1" y="1" width="278" height="146" rx="12" fill="#141a2e" stroke="rgba(255,255,255,.08)"/>
        <circle cx="205" cy="44" r="14" fill="#6ea8ff"/>
        <rect x="46" y="28" width="64" height="64" rx="24" fill="#1b2340" stroke="#6ea8ff" stroke-width="3"/>
        <circle cx="78" cy="60" r="18" fill="none" stroke="#6ea8ff" stroke-dasharray="3 5" stroke-width="3"/>
        <rect x="106" y="58" width="74" height="8" rx="4" fill="#6ea8ff"/>
        <rect x="168" y="62" width="60" height="4" rx="2" fill="#6ea8ff" opacity=".6"/>
        <rect x="106" y="72" width="96" height="6" rx="3" fill="#8fa3c7" opacity=".55"/>
        <rect x="106" y="82" width="84" height="6" rx="3" fill="#8fa3c7" opacity=".35"/>
      </svg>
    </div>

    <form method="post" style="display:grid; gap:12px;">
      <!-- COMPAÑERO -->
      <div>
        <label for="companero_id" style="display:block; font-weight:600; margin-bottom:4px;">
          Compañero (misma categoría y en zona de ascenso)
        </label>
        <select id="companero_id" name="companero_id" style="width:100%;" required>
          <option value="">-- Elegí compañero --</option>
          {% for j in candidatos_companero %}
            <option value="{{ j.id }}">{{ j.nombre_completo }} — {{ j.puntos }} pts</option>
          {% endfor %}
        </select>
        <div class="muted" style="font-size:.9rem; margin-top:4px;">
          Tip: buscá a quien esté ≤ al mínimo de tu categoría para cumplir la condición.
        </div>
      </div>

      <!-- RIVALES -->
      <div style="display:grid; gap:12px; grid-template-columns:repeat(auto-fit,minmax(240px,1fr));">
        <div>
          <label for="rival1_id" style="display:block; font-weight:600; margin-bottom:4px;">
            Rival 1 (categoría superior{% if cat_superior_nombre %}: {{ cat_superior_nombre }}{% endif %})
          </label>
          <select id="rival1_id" name="rival1_id" style="width:100%;" required>
            <option value="">-- Elegí rival 1 --</option>
            {% for j in candidatos_rivales %}
              <option value="{{ j.id }}">{{ j.nombre_completo }} — {{ j.puntos }} pts</option>
            {% endfor %}
          </select>
        </div>

        <div>
          <label for="rival2_id" style="display:block; font-weight:600; margin-bottom:4px;">
            Rival 2 (categoría superior{% if cat_superior_nombre %}: {{ cat_superior_nombre }}{% endif %})
          </label>
          <select id="rival2_id" name="rival2_id" style="width:100%;" required>
            <option value="">-- Elegí rival 2 --</option>
            {% for j in candidatos_rivales %}
              <option value="{{ j.id }}">{{ j.nombre_completo }} — {{ j.puntos }} pts</option>
            {% endfor %}
          </select>
        </div>
      </div>

      <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:4px;">
        <button type="submit" class="btn">Crear desafío</button>
        <a href="{{ url_for('desafios_list') }}" class="btn btn-ghost">Cancelar</a>
      </div>
    </form>
  </div>

  <div class="card" style="max-width:900px;">
    <h3 style="margin:0 0 6px;">Reglas</h3>
    <ul style="margin:8px 0 0 18px; padding:0; color:var(--muted);">
      <li>El desafiante y su compañero deben estar en <strong>zona de ascenso</strong> (puntos ≤ mínimo de su categoría).</li>
      <li>Ambos rivales deben pertenecer al <strong>nivel superior</strong> del desafiante.</li>
      <li>Una vez creado el desafío, cada rival puede <em>aceptar</em> o <em>rechazar</em>. Con las dos aceptaciones, ya podés programar el partido.</li>
    </ul>
  </div>
{% endblock %}

{% block help_content %}
<style>
  /* ==== Modal de ayuda compacto con scroll propio (mismo patrón que index/partidos) ==== */
  .help-container{ display:flex; justify-content:center; width:100%; }
  .help-wrap{
    width: min(820px, 92vw);
    margin: 0 auto;

    max-height: 62dvh; /* contenedor más bajo para que siempre entre */
    max-height: 62vh;
    overflow: auto;
    overscroll-behavior: contain;

    position: relative;
    background: transparent;
  }

  .help-head{
    position: sticky; top: 0; z-index: 2;
    display:flex; align-items:center; gap:6px;
    padding:6px 6px; margin-bottom:4px;
    background: var(--bg, rgba(10,12,20,.96));
    border-bottom:1px solid rgba(255,255,255,.06);
  }
  .help-title{ margin:0; font-size: clamp(.92rem, 2vw, 1.02rem); }
  .help-sub{   margin:0; color:var(--muted,#98a2b3); font-size: clamp(.78rem, 1.7vw, .88rem); }

  .help-grid{
    display:grid;
    grid-template-columns: repeat(auto-fit, minmax(236px, 1fr));
    gap:8px;
  }

  .help-card{
    background: rgba(255,255,255,.04);
    border:1px solid rgba(255,255,255,.08);
    border-radius:10px;
    padding:6px;
  }
  .help-card h4{
    display:flex; align-items:center; gap:6px;
    margin:0 0 4px;
    font-size: clamp(.88rem, 1.9vw, .96rem);
  }
  .help-card p, .help-card li{
    margin:3px 0;
    font-size: clamp(.78rem, 1.6vw, .86rem);
    line-height:1.3;
  }
  .help-ul, .help-ol{ padding-left:16px; margin:4px 0; }

  .help-badges { display:flex; gap:6px; flex-wrap:wrap; margin-top:4px; }
  .chip{ display:inline-block; padding:2px 7px; border-radius:999px; font-size:.76rem; border:1px solid #2a2f45; background:#1b2138;}
  .chip.ok{ background:#1b3b2a; border-color:#1a704d; }
  .chip.warn{ background:#3b2f1b; border-color:#704d1a; }
  .chip.info{ background:#1b2f3b; border-color:#1a4d70; }
  .chip.danger{ background:#3b1b1b; border-color:#701a1a; }

  .help-visual{
    display:flex; align-items:center; justify-content:center;
    background: rgba(255,255,255,.03);
    border:1px dashed rgba(255,255,255,.12);
    border-radius:10px; padding:6px;
  }
  .help-visual svg{ max-width:100%; height:auto; display:block; }

  @media (max-width:540px){
    .help-grid{ grid-template-columns: 1fr; }
    .help-card h4 svg{ display:none; }
  }
</style>

<div class="help-container">
  <div class="help-wrap">
    <div class="help-head">
      <h3 class="help-title">Nuevo desafío — guía rápida</h3>
      <p class="help-sub">Elegí compañero (en zona) y dos rivales del nivel superior</p>
    </div>

    <div class="help-grid">
      <!-- Qué es -->
      <section class="help-card">
        <h4>
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M4 6h16M4 12h14M4 18h10" stroke="currentColor"/></svg>
          ¿Qué es un desafío?
        </h4>
        <p>Es un <strong>partido inter-nivel</strong>: vos + un compañero de tu categoría (en <em>zona de ascenso</em>) retan a dos jugadores del nivel superior.</p>
        <div class="help-badges">
          <span class="chip.info">Inter-nivel</span>
          <span class="chip.ok">Zona de ascenso</span>
          <span class="chip.warn">Pendiente</span>
          <span class="chip.ok">Aceptado</span>
        </div>
      </section>

      <!-- Quiénes pueden desafiar -->
      <section class="help-card">
        <h4>
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M6 6h12v12H6z" stroke="currentColor"/></svg>
          Quiénes pueden desafiar
        </h4>
        <ul class="help-ul">
          <li>Desafiante y compañero deben estar en <strong>zona de ascenso</strong> (puntos ≤ mínimo de su categoría).</li>
          <li>Los dos rivales deben pertenecer a la <strong>categoría superior</strong>.</li>
        </ul>
      </section>

      <!-- Cómo elegir -->
      <section class="help-card">
        <h4>
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M12 3v18M3 12h18" stroke="currentColor"/></svg>
          Cómo elegir jugadores
        </h4>
        <ul class="help-ul">
          <li><strong>Compañero:</strong> misma categoría que vos y ≤ al mínimo.</li>
          <li><strong>Rivales:</strong> ambos del nivel superior ({{ cat_superior_nombre or 'categoría superior' }}).</li>
        </ul>
      </section>

      <!-- Flujo -->
      <section class="help-card">
        <h4>
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M4 12h6l2-3 2 6 2-3h4" stroke="currentColor"/></svg>
          Flujo en 4 pasos
        </h4>
        <ol class="help-ol">
          <li>Elegís <em>compañero</em> y <em>rivales</em> y creás el desafío.</li>
          <li>Cada rival <strong>acepta</strong> o <strong>rechaza</strong> (necesitás 2/2).</li>
          <li>Con 2/2, estado <strong>ACEPTADO</strong> → <em>Programar partido</em>.</li>
          <li>Jugado el partido, <strong>cargar resultado</strong> y confirmar.</li>
        </ol>
      </section>

      <!-- Visual -->
      <section class="help-card">
        <h4>
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><circle cx="12" cy="12" r="9" stroke="currentColor"/></svg>
          Ejemplo visual
        </h4>
        <div class="help-visual">
          <svg width="260" height="110" viewBox="0 0 280 120" aria-hidden="true">
            <rect x="1" y="1" width="278" height="118" rx="10" fill="#0f172a" stroke="rgba(255,255,255,.12)"/>
            <!-- Desafiante + compañero -->
            <circle cx="70" cy="44" r="10" fill="#22c55e"/>
            <circle cx="98" cy="44" r="10" fill="#22c55e" opacity=".85"/>
            <!-- Rivales (superior) -->
            <circle cx="176" cy="78" r="10" fill="#60a5fa"/>
            <circle cx="204" cy="78" r="10" fill="#60a5fa" opacity=".85"/>
            <!-- Flecha envío -->
            <path d="M116 44h44" stroke="#eab308" stroke-width="3"/>
            <path d="M160 44l-8-6v12l8-6z" fill="#eab308"/>
            <!-- Chips -->
            <rect x="16" y="12" rx="6" ry="6" width="70" height="18" fill="#1b2f3b"/>
            <text x="51" y="25" fill="#fff" font-size="10" text-anchor="middle">DESAFÍO</text>
            <rect x="96" y="12" rx="6" ry="6" width="90" height="18" fill="#3b2f1b"/>
            <text x="141" y="25" fill="#fff" font-size="10" text-anchor="middle">PENDIENTE</text>
            <rect x="190" y="12" rx="6" ry="6" width="74" height="18" fill="#1b3b2a"/>
            <text x="227" y="25" fill="#fff" font-size="10" text-anchor="middle">ACEPTADO</text>
          </svg>
        </div>
        <p class="muted" style="margin-top:4px;">Verde: desafiante+compañero · Celeste: rivales · Amarillo: envío del desafío</p>
      </section>

      <!-- Tips -->
      <section class="help-card">
        <h4>
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M12 2l3 7h7l-5.5 4 2 7-6.5-4.5L5 20l2-7L1 9h7l4-7z" stroke="currentColor"/></svg>
          Tips rápidos
        </h4>
        <ul class="help-ul">
          <li>Si no ves a alguien en la lista, puede no estar en zona o no ser elegible.</li>
          <li>Podés volver a esta página desde <strong>Desafíos</strong> o <strong>Mi Panel</strong>.</li>
          <li>Cuando ambos rivales acepten, verás el botón <em>Programar partido</em>.</li>
        </ul>
        <div class="help-badges">
          <a href="{{ url_for('desafios_list') }}" class="chip">Ver mis desafíos</a>
          <a href="{{ url_for('mi_panel') }}" class="chip">Mi Panel</a>
        </div>
      </section>
    </div>
  </div>
</div>
{% endblock %}
