{% extends "base.html" %}
{% block title %}Iniciar sesi√≥n{% endblock %}

{% block content %}
  <div style="display:flex; align-items:center; gap:10px; margin-bottom:8px;">
    <h2 style="margin:0;">Iniciar sesi√≥n</h2>
    <a href="{{ url_for('alta_publica') }}" class="btn btn-ghost btn-slim">Pedir alta</a>
  </div>

  <div class="card" style="max-width:560px;">
    <form method="post" style="display:grid; gap:10px;" novalidate>
      <!-- Buscador r√°pido de jugador -->
      <div>
        <label for="buscar" class="muted" style="display:block; margin-bottom:4px;">Buscar jugador</label>
        <input id="buscar" type="text" placeholder="Escrib√≠ para filtrar por nombre‚Ä¶" autocomplete="off" style="width:100%;" aria-describedby="buscar-estado">
        <div id="buscar-estado" class="muted" style="margin:.35rem 0 0; font-size:.9rem;"></div>
      </div>

      <div>
        <label for="jugador_id" class="muted" style="display:block; margin-bottom:4px;">Tu nombre</label>
        <select id="jugador_id" name="jugador_id" required style="width:100%;" aria-describedby="ayuda-jugador">
          <option value="">-- Eleg√≠ tu nombre --</option>
          {% for j in jugadores %}
            <option value="{{ j.id }}">
              {{ j.nombre_completo }} ‚Äî {{ j.categoria.nombre if j.categoria else '-' }}
            </option>
          {% endfor %}
        </select>
        <p id="ayuda-jugador" class="muted" style="margin:.35rem 0 0; font-size:.92rem;">
          Si no aparec√©s, ped√≠ el alta al organizador.
        </p>

        {% if jugadores|length == 0 %}
          <p class="muted" style="margin:.35rem 0 0;">
            No hay jugadores activos cargados. <a href="{{ url_for('alta_publica') }}">Ped√≠ alta</a> o contact√° a un admin.
          </p>
        {% endif %}
      </div>

      <div>
        <label for="pin" class="muted" style="display:block; margin-bottom:4px;">PIN</label>
        <div style="display:flex; gap:8px;">
          <input id="pin" name="pin" type="password" inputmode="numeric" pattern="\\d{4,6}" minlength="4" maxlength="6"
                 required placeholder="4‚Äì6 d√≠gitos" autocomplete="current-password" style="width:100%;">
          <button type="button" id="togglePin" class="btn btn-ghost btn-slim" aria-pressed="false" aria-controls="pin">üëÅ</button>
        </div>
        <p class="muted" style="margin:.35rem 0 0; font-size:.92rem;">
          El PIN lo define el organizador. Podr√°s cambiarlo luego desde <em>Editar jugador</em>.
        </p>
        <p style="margin:.35rem 0 0;">
          <a href="{{ url_for('olvide_pin') }}" class="btn btn-ghost btn-slim">Olvid√© mi PIN</a>
        </p>
      </div>

      <div style="display:flex; gap:8px; flex-wrap:wrap; align-items:center; margin-top:4px;">
        <button type="submit" class="btn">Entrar</button>
        <a href="{{ url_for('alta_publica') }}" class="btn btn-ghost">No figuro, pedir alta</a>
        <a href="{{ url_for('ranking') }}" class="btn btn-ghost">Ver ranking</a>
      </div>
    </form>
  </div>

  <div class="card" style="border-style:dashed; margin-top:10px; max-width:560px;">
    <p style="margin:0;">
      ¬øProblemas para ingresar? Verific√° que tu nombre est√© en la lista y que el PIN sea correcto.
    </p>
  </div>

  <script>
    // --- Utilidades
    const normalizar = (s) => (s || '')
      .toLowerCase()
      .normalize('NFD')
      .replace(/[\u0300-\u036f]/g, '')
      .trim();

    const buscar = document.getElementById('buscar');
    const select = document.getElementById('jugador_id');
    const estado = document.getElementById('buscar-estado');
    const pin = document.getElementById('pin');
    const toggle = document.getElementById('togglePin');

    if (buscar && select) {
      // Clonamos opciones originales para rearmar la lista r√°pido
      const optsOriginales = Array.from(select.options).map(o => o.cloneNode(true));
      const optBase = optsOriginales[0];           // "-- Eleg√≠ tu nombre --"
      const optResto = optsOriginales.slice(1);    // jugadores

      // Render helper
      function renderLista(coincidentes) {
        // Limpio y vuelvo a poner la base
        select.innerHTML = '';
        select.appendChild(optBase.cloneNode(true));

        if (coincidentes.length === 0) {
          const vacio = document.createElement('option');
          vacio.disabled = true;
          vacio.textContent = '‚Äî Sin resultados ‚Äî';
          select.appendChild(vacio);
          estado.textContent = 'Sin resultados.';
          select.selectedIndex = 0;
          return;
        }

        // Agrego coincidencias
        coincidentes.forEach(o => select.appendChild(o.cloneNode(true)));

        // Auto-seleccionar primera coincidencia
        select.selectedIndex = 1;

        // Estado accesible
        estado.textContent = `${coincidentes.length} resultado${coincidentes.length === 1 ? '' : 's'}.`;
      }

      // Filtro (tokeniza para b√∫squedas "nombre apellido")
      function filtrar(qRaw) {
        const q = normalizar(qRaw);
        if (!q) {
          // Reset
          renderLista(optResto);
          estado.textContent = '';
          select.selectedIndex = 0;
          return;
        }
        const tokens = q.split(/\s+/).filter(Boolean);
        const coincide = (texto) => {
          const t = normalizar(texto);
          return tokens.every(tok => t.includes(tok));
        };
        const match = optResto.filter(o => coincide(o.textContent || o.innerText || ''));
        renderLista(match);
      }

      // Eventos
      buscar.addEventListener('input', () => filtrar(buscar.value));

      // Enter desde el buscador: si hay UNA coincidencia, confirmo y voy a PIN
      buscar.addEventListener('keydown', (ev) => {
        if (ev.key === 'Enter') {
          ev.preventDefault();
          const total = select.options.length;
          // Base + (1) √∫nica coincidencia = 2 opciones totales
          if (total === 2 && !select.options[1].disabled) {
            select.selectedIndex = 1;
            pin && pin.focus();
          } else {
            // Si hay varias, mantengo la auto-selecci√≥n en la primera
            if (total > 1) {
              select.selectedIndex = 1;
              pin && pin.focus();
            }
          }
        }
      });
    }

    // --- Mostrar/Ocultar PIN
    if (pin && toggle){
      toggle.addEventListener('click', () => {
        const isPass = pin.type === 'password';
        pin.type = isPass ? 'text' : 'password';
        toggle.setAttribute('aria-pressed', String(isPass));
      });
    }
  </script>
{% endblock %}

{% block help_content %}
<!-- (sin cambios) -->
{% endblock %}
