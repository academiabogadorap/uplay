{% extends "base.html" %}
{% block title %}Nuevo partido{% endblock %}
{% block content %}
  <div style="display:flex; align-items:center; gap:10px; margin-bottom:8px;">
    <h2 style="margin:0;">Crear nuevo partido</h2>
    <a href="{{ url_for('partidos_list') }}" class="btn btn-ghost">Volver</a>
  </div>

  <div class="card" style="max-width:760px;">
    <p style="margin:0 0 8px;">
      Categoría: <strong>{{ categoria.nombre }}</strong>
      <span class="muted" style="margin-left:6px;">rango {{ categoria.puntos_min }}–{{ categoria.puntos_max }}</span>
    </p>

    <form method="post" id="form-nuevo-partido" style="display:grid; gap:10px;">
      <div>
        <label class="muted">Compañero</label>
        <select name="companero_id" id="companero_id" required>
          <option value="">-- Elegí tu compañero --</option>
          {% for u in candidatos_companero %}
            <option value="{{ u.id }}">{{ u.nombre_completo }}</option>
          {% endfor %}
        </select>
        {% if not candidatos_companero or candidatos_companero|length == 0 %}
          {% endif %}
      </div>

      <div>
        <label class="muted">Rival 1</label>
        <select name="rival1_id" id="rival1_id" required>
          <option value="">-- Elegí rival 1 --</option>
          {% for u in candidatos_rivales %}
            <option value="{{ u.id }}">{{ u.nombre_completo }}</option>
          {% endfor %}
        </select>
      </div>

      <div>
        <label class="muted">Rival 2</label>
        <select name="rival2_id" id="rival2_id" required>
          <option value="">-- Elegí rival 2 --</option>
          {% for u in candidatos_rivales %}
            <option value="{{ u.id }}">{{ u.nombre_completo }}</option>
          {% endfor %}
        </select>
      </div>

      <p class="muted" style="margin:0;">
        Tip: a medida que elijas, los otros selects se filtran para evitar duplicados.
      </p>

      <div>
        <label class="muted">Fecha (opcional)</label>
        <input type="datetime-local" name="fecha">
      </div>

      <div style="display:flex; gap:8px; margin-top:4px;">
        <button type="submit" id="btn-submit" class="btn"
          {% if (not candidatos_companero or candidatos_companero|length == 0) or (not candidatos_rivales or candidatos_rivales|length < 2) %}disabled{% endif %}>
          Crear partido
        </button>
        <a href="{{ url_for('partidos_list') }}" class="btn btn-ghost">Cancelar</a>
      </div>
    </form>
  </div>

  <script>
    (function() {
      // Lista robusta [{id, name}] sin usar __dict__
      const players = [
        {% for u in candidatos_rivales -%}
          {"id": "{{ u.id }}", "name": {{ u.nombre_completo|tojson }} }{% if not loop.last %},{% endif %}
        {%- endfor %}
      ];

      const sComp = document.getElementById('companero_id');
      const sR1 = document.getElementById('rival1_id');
      const sR2 = document.getElementById('rival2_id');

      function optionPlaceholder(text) {
        const opt = document.createElement('option');
        opt.value = '';
        opt.textContent = text;
        return opt;
      }

      function renderOptions(select, placeholder, excludeIds, keepValue) {
        const keepStr = keepValue ? String(keepValue) : '';
        while (select.firstChild) select.removeChild(select.firstChild);
        select.appendChild(optionPlaceholder(placeholder));

        players.forEach(p => {
          const excluded = excludeIds.has(String(p.id));
          // Permitimos mantener el value actual aunque esté excluido
          if (!excluded || String(p.id) === keepStr) {
            const opt = document.createElement('option');
            opt.value = String(p.id);
            opt.textContent = p.name;
            select.appendChild(opt);
          }
        });

        if (keepStr && Array.from(select.options).some(o => o.value === keepStr)) {
          select.value = keepStr;
        } else {
          select.value = '';
        }
      }

      function updateAll() {
        const vComp = sComp.value;
        const vR1 = sR1.value;
        const vR2 = sR2.value;

        const exclForComp = new Set([vR1, vR2].filter(Boolean));
        const exclForR1   = new Set([vComp, vR2].filter(Boolean));
        const exclForR2   = new Set([vComp, vR1].filter(Boolean));

        renderOptions(sComp, '-- Elegí tu compañero --', exclForComp, vComp);
        renderOptions(sR1,  '-- Elegí rival 1 --',      exclForR1,   vR1);
        renderOptions(sR2,  '-- Elegí rival 2 --',      exclForR2,   vR2);
      }

      sComp.addEventListener('change', updateAll);
      sR1.addEventListener('change', updateAll);
      sR2.addEventListener('change', updateAll);

      updateAll();
    })();
  </script>
{% endblock %}

{% block help_content %}
<style>
  /* ==== Modal de ayuda compacto con scroll propio (mismo patrón que el resto) ==== */
  .help-container{ display:flex; justify-content:center; width:100%; }
  .help-wrap{
    width: min(800px, 90vw);
    margin: 0 auto;

    /* Altura reducida + scroll en el contenedor */
    max-height: 58dvh;
    max-height: 58vh;   /* fallback */
    overflow: auto;
    overscroll-behavior: contain;

    position: relative;
    background: transparent;
  }

  /* Header compacto y sticky */
  .help-head{
    position: sticky; top: 0; z-index: 2;
    display:flex; align-items:center; gap:6px;
    padding:6px 6px; margin-bottom:4px;
    background: var(--bg, rgba(10,12,20,.96));
    border-bottom:1px solid rgba(255,255,255,.06);
  }
  .help-title{ margin:0; font-size: clamp(.9rem, 1.9vw, 1rem); }
  .help-sub{   margin:0; color:var(--muted,#98a2b3); font-size: clamp(.78rem, 1.6vw, .88rem); }

  /* Grid */
  .help-grid{
    display:grid;
    grid-template-columns: repeat(auto-fit, minmax(236px, 1fr));
    gap:8px;
  }

  /* Cards */
  .help-card{
    background: rgba(255,255,255,.04);
    border:1px solid rgba(255,255,255,.08);
    border-radius:10px;
    padding:6px;
  }
  .help-card h4{
    display:flex; align-items:center; gap:6px;
    margin:0 0 4px;
    font-size: clamp(.86rem, 1.8vw, .96rem);
  }
  .help-card p, .help-card li{
    margin:3px 0;
    font-size: clamp(.76rem, 1.5vw, .86rem);
    line-height:1.28;
  }
  .help-ul, .help-ol{ padding-left:16px; margin:4px 0; }

  .help-badges { display:flex; gap:6px; flex-wrap:wrap; margin-top:4px; }
  .chip{ display:inline-block; padding:2px 7px; border-radius:999px; font-size:.74rem; border:1px solid #2a2f45; background:#1b2138;}
  .chip.ok{ background:#1b3b2a; border-color:#1a704d; }
  .chip.warn{ background:#3b2f1b; border-color:#704d1a; }
  .chip.info{ background:#1b2f3b; border-color:#1a4d70; }

  .help-visual{
    display:flex; align-items:center; justify-content:center;
    background: rgba(255,255,255,.03);
    border:1px dashed rgba(255,255,255,.12);
    border-radius:10px; padding:6px;
  }
  .help-visual svg{ max-width:100%; height:auto; display:block; }

  @media (max-width:540px){
    .help-grid{ grid-template-columns: 1fr; }
    .help-card h4 svg{ display:none; }
  }
</style>

<div class="help-container">
  <div class="help-wrap">
    <div class="help-head">
      <h3 class="help-title">Nuevo partido — guía rápida</h3>
      <p class="help-sub">Elegí compañero, rivales y (opcional) fecha</p>
    </div>

    <div class="help-grid">
      <!-- Qué estás creando -->
      <section class="help-card">
        <h4>
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
            <path d="M4 6h16M4 12h14M4 18h10" stroke="currentColor"/>
          </svg>
          ¿Qué estás creando?
        </h4>
        <p>Un <strong>partido en tu categoría</strong>. Al crearlo, los rivales reciben una invitación para <em>aceptar</em> o <em>rechazar</em>.</p>
        <div class="help-badges">
          <span class="chip info">Invitación</span>
          <span class="chip ok">Aceptado</span>
          <span class="chip warn">Pendiente</span>
        </div>
      </section>

      <!-- Selección inteligente -->
      <section class="help-card">
        <h4>
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
            <path d="M12 3v18M3 12h18" stroke="currentColor"/>
          </svg>
          Selección sin duplicados
        </h4>
        <ul class="help-ul">
          <li>Los selectores se <strong>filtran solos</strong> para que nadie se repita.</li>
          <li>Si cambiás una opción, las otras listas se actualizan.</li>
        </ul>
      </section>

      <!-- Reglas básicas -->
      <section class="help-card">
        <h4>
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
            <path d="M6 6h12v12H6z" stroke="currentColor"/>
          </svg>
          Reglas básicas
        </h4>
        <ul class="help-ul">
          <li>Compañero y rivales deben ser <strong>jugadores activos de la categoría</strong>.</li>
          <li>Se necesitan <strong>ambas aceptaciones</strong> de rivales para considerarlo aceptado.</li>
          <li>Podés indicar una <strong>fecha</strong> (opcional).</li>
        </ul>
      </section>

      <!-- Flujo -->
      <section class="help-card">
        <h4>
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
            <path d="M4 12h6l2-3 2 6 2-3h4" stroke="currentColor"/>
          </svg>
          Flujo en 4 pasos
        </h4>
        <ol class="help-ol">
          <li>Elegís <em>compañero</em> y <em>rivales</em> y creás el partido.</li>
          <li>Los rivales <strong>aceptan</strong> la invitación.</li>
          <li>Juegan el partido en la fecha acordada.</li>
          <li>Una pareja <strong>propone el resultado</strong> y la otra confirma.</li>
        </ol>
      </section>

      <!-- Visual -->
      <section class="help-card">
        <h4>
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
            <circle cx="12" cy="12" r="9" stroke="currentColor"/>
          </svg>
          Ejemplo visual
        </h4>
        <div class="help-visual">
          <svg width="260" height="110" viewBox="0 0 280 120" aria-hidden="true">
            <rect x="1" y="1" width="278" height="118" rx="10" fill="#0f172a" stroke="rgba(255,255,255,.12)"/>
            <!-- Pareja 1 -->
            <circle cx="76" cy="44" r="10" fill="#22c55e"/>
            <circle cx="104" cy="44" r="10" fill="#22c55e" opacity=".85"/>
            <!-- Pareja 2 -->
            <circle cx="176" cy="78" r="10" fill="#60a5fa"/>
            <circle cx="204" cy="78" r="10" fill="#60a5fa" opacity=".85"/>
            <!-- Flecha invitación -->
            <path d="M120 44h44" stroke="#eab308" stroke-width="3"/>
            <path d="M164 44l-8-6v12l8-6z" fill="#eab308"/>
            <!-- Chips -->
            <rect x="16" y="12" rx="6" ry="6" width="70" height="18" fill="#1b2f3b"/>
            <text x="51" y="25" fill="#fff" font-size="10" text-anchor="middle">INVITACIÓN</text>
            <rect x="96" y="12" rx="6" ry="6" width="64" height="18" fill="#3b2f1b"/>
            <text x="128" y="25" fill="#fff" font-size="10" text-anchor="middle">PENDIENTE</text>
            <rect x="166" y="12" rx="6" ry="6" width="64" height="18" fill="#1b3b2a"/>
            <text x="198" y="25" fill="#fff" font-size="10" text-anchor="middle">ACEPTADO</text>
          </svg>
        </div>
      </section>

      <!-- Tips -->
      <section class="help-card">
        <h4>
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
            <path d="M12 2l3 7h7l-5.5 4 2 7-6.5-4.5L5 20l2-7L1 9h7l4-7z" stroke="currentColor"/>
          </svg>
          Tips rápidos
        </h4>
        <ul class="help-ul">
          <li>Si el botón <em>Crear partido</em> está deshabilitado, verificá que haya <strong>1 compañero</strong> y <strong>2 rivales</strong> disponibles.</li>
          <li>Podés dejar la <em>fecha</em> vacía y coordinar luego.</li>
          <li>Después de jugar, cargá el <strong>resultado</strong> desde la lista de partidos.</li>
        </ul>
      </section>
    </div>
  </div>
</div>
{% endblock %}
