{% extends "base.html" %}
{% block title %}Ranking{% endblock %}
{% block content %}
  <h2 style="margin-bottom:6px;">Ranking</h2>
  <p style="margin:6px 0; color:#555;">Superior → inferior, y dentro de cada nivel por puntos (mejor = número más bajo).</p>

  <!-- Filtros -->
  <form method="get" class="card" style="max-width:900px;">
    <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
      <label for="rama"><strong>Rama</strong></label>
      <select id="rama" name="rama" style="max-width:220px;">
        <option value="">Todas</option>
        <option value="CABALLEROS" {% if rama_filtro == 'CABALLEROS' %}selected{% endif %}>Caballeros</option>
        <option value="DAMAS" {% if rama_filtro == 'DAMAS' %}selected{% endif %}>Damas</option>
        <option value="MIXTA" {% if rama_filtro == 'MIXTA' %}selected{% endif %}>Mixta</option>
      </select>

      <!-- NUEVO: filtro por categoría (se llena según la rama seleccionada) -->
      <label for="categoria_id"><strong>Categoría</strong></label>
      <select id="categoria_id" name="categoria_id" style="max-width:260px;">
        <option value="">Todas</option>
        {% for c in categorias_visible %}
          <option value="{{ c.id }}" {% if categoria_id == c.id %}selected{% endif %}>
            {{ c.nombre }} ({{ c.puntos_min }}–{{ c.puntos_max }})
          </option>
        {% endfor %}
      </select>

      <button type="submit" class="btn">Aplicar</button>
      <a href="{{ url_for('ranking') }}" class="btn btn-ghost">Limpiar</a>

      <div class="spacer"></div>
      <input id="searchBox" placeholder="Buscar jugador..." style="max-width:260px;">
    </div>
  </form>

  {% if grupos and grupos|length > 0 %}
    <div class="card" style="padding:0;">
      <div class="table-scroll" style="--thead-h: 44px; max-height:70vh; overflow:auto; border-radius:10px;">
        <table id="rankingTable" style="margin:0;">
          <thead>
            <tr>
              <th style="width:44px;">#</th>
              <th>Nombre</th>
              <th>Puntos</th>
              <th>Categoría</th>
              <th>Zona ascenso</th>
              <th>Rivales en nivel superior</th>
              <th>Acción</th>
            </tr>
          </thead>
          <tbody>
            {% for cat, filas in grupos %}
              <tr class="cat-sep">
                <td colspan="7">
                  {{ cat.nombre }} ({{ cat.puntos_min }}–{{ cat.puntos_max }})
                </td>
              </tr>

              {% if filas and filas|length > 0 %}
                {% for j in filas %}
                  {% set es_yo = (current_jugador and j.id == current_jugador.id) %}
                  <tr class="{% if es_yo %}row-highlight{% endif %}">
                    <td>{{ loop.index }}</td>
                    <td class="col-nombre">{{ j.nombre_completo }}</td>
                    <td>{{ j.puntos }}</td>
                    <td>{{ cat.nombre }}</td>
                    <td>
                      {% if zona_ascenso.get(j.id) %}
                        <span class="badge badge-ok">Sí</span>
                      {% else %}
                        No
                      {% endif %}
                    </td>
                    <td>{{ rivales_count.get(j.id, 0) }}</td>
                    <td>
                      {% if zona_ascenso.get(j.id) and rivales_count.get(j.id, 0) > 0 %}
                        <a href="{{ url_for('desafios_new', desafiante_id=j.id) }}" class="btn">Desafiar</a>
                      {% else %}
                        —
                      {% endif %}
                    </td>
                  </tr>
                {% endfor %}
              {% else %}
                <tr>
                  <td colspan="7" style="color:#777;">Sin jugadores en esta categoría.</td>
                </tr>
              {% endif %}
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  {% else %}
    <p>No hay jugadores suscriptos (o no hay categorías para la rama/categoría filtrada).</p>
  {% endif %}

  <style>
    #rankingTable thead th{
      position: sticky;
      top: 0;
      z-index: 3;
      background: #0d1b2a;
      color: #dbe2ef;
      text-align: left;
      padding: 10px 8px;
      height: var(--thead-h);
      line-height: 1.1;
      text-transform: uppercase;
      letter-spacing: .02em;
      box-shadow: 0 2px 0 rgba(0,0,0,.25);
    }
    #rankingTable td{ padding: 10px 8px; }
    .table-scroll .cat-sep{ position: sticky; top: var(--thead-h); z-index: 2; }
    .table-scroll .cat-sep td{
      background: #132238; color: #9fb3c8; font-weight: 600;
      border-top: 1px solid var(--muted); border-bottom: 1px solid var(--muted);
      padding: 8px;
    }
    #rankingTable tbody tr:not(.cat-sep):hover{ background: rgba(255,255,255,.04); }
  </style>

  <script>
    // Filtro por nombre (cliente)
    (function () {
      const box = document.getElementById('searchBox');
      const table = document.getElementById('rankingTable');
      if (!box || !table) return;

      box.addEventListener('input', function () {
        const q = this.value.trim().toLowerCase();
        const rows = table.querySelectorAll('tbody tr');

        const rowsArr = Array.from(rows);
        for (let i = 0; i < rowsArr.length; i++) {
          const r = rowsArr[i];
          if (r.classList.contains('cat-sep')) { r.style.display = ''; continue; }
          const nameCell = r.querySelector('.col-nombre');
          const visible = !q || (nameCell && nameCell.textContent.toLowerCase().includes(q));
          r.style.display = visible ? '' : 'none';
        }

        // ocultar separadores sin filas visibles debajo
        for (let i = 0; i < rowsArr.length; i++) {
          const sep = rowsArr[i];
          if (!sep.classList.contains('cat-sep')) continue;
          let hasVisible = false;
          for (let j = i + 1; j < rowsArr.length; j++) {
            if (rowsArr[j].classList.contains('cat-sep')) break;
            if (rowsArr[j].style.display !== 'none') { hasVisible = true; break; }
          }
          sep.style.display = hasVisible ? '' : 'none';
        }
      });
    })();
  </script>
{% endblock %}

{% block help_content %}
<style>
  /* ==== Modal de ayuda compacto con scroll propio (mismo patrón del resto) ==== */
  .help-container{ display:flex; justify-content:center; width:100%; }
  .help-wrap{
    width: min(800px, 90vw);
    margin: 0 auto;

    /* Altura reducida + scroll en el contenedor */
    max-height: 62dvh;
    max-height: 62vh;   /* fallback */
    overflow: auto;
    overscroll-behavior: contain;

    position: relative;
    background: transparent;
  }

  /* Header compacto y sticky */
  .help-head{
    position: sticky; top: 0; z-index: 2;
    display:flex; align-items:center; gap:6px;
    padding:6px 6px; margin-bottom:4px;
    background: var(--bg, rgba(10,12,20,.96));
    border-bottom:1px solid rgba(255,255,255,.06);
  }
  .help-title{ margin:0; font-size: clamp(.92rem, 2vw, 1.02rem); }
  .help-sub{   margin:0; color:var(--muted,#98a2b3); font-size: clamp(.78rem, 1.7vw, .88rem); }

  /* Grid */
  .help-grid{
    display:grid;
    grid-template-columns: repeat(auto-fit, minmax(236px, 1fr));
    gap:8px;
  }

  /* Cards */
  .help-card{
    background: rgba(255,255,255,.04);
    border:1px solid rgba(255,255,255,.08);
    border-radius:10px;
    padding:6px;
  }
  .help-card h4{
    display:flex; align-items:center; gap:6px;
    margin:0 0 4px;
    font-size: clamp(.88rem, 1.9vw, .96rem);
  }
  .help-card p, .help-card li{
    margin:3px 0;
    font-size: clamp(.78rem, 1.6vw, .86rem);
    line-height:1.3;
  }
  .help-ul, .help-ol{ padding-left:16px; margin:4px 0; }

  .help-badges { display:flex; gap:6px; flex-wrap:wrap; margin-top:4px; }
  .chip{ display:inline-block; padding:2px 7px; border-radius:999px; font-size:.76rem; border:1px solid #2a2f45; background:#1b2138;}
  .chip.ok{ background:#1b3b2a; border-color:#1a704d; }
  .chip.warn{ background:#3b2f1b; border-color:#704d1a; }
  .chip.info{ background:#1b2f3b; border-color:#1a4d70; }

  .help-visual{
    display:flex; align-items:center; justify-content:center;
    background: rgba(255,255,255,.03);
    border:1px dashed rgba(255,255,255,.12);
    border-radius:10px; padding:6px;
  }
  .help-visual svg, .help-card img{ max-width:100%; height:auto; display:block; }

  @media (max-width:540px){
    .help-grid{ grid-template-columns: 1fr; }
    .help-card h4 svg{ display:none; }
  }
</style>

<div class="help-container">
  <div class="help-wrap">
    <div class="help-head">
      <h3 class="help-title">¿Cómo leer el Ranking?</h3>
      <p class="help-sub">Guía rápida y visual</p>
    </div>

    <div class="help-grid">
      <!-- ¿Qué estás viendo? -->
      <section class="help-card">
        <h4>
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M3 6h18M6 10h12M4 14h16" stroke="currentColor"/>
          </svg>
          ¿Qué estás viendo?
        </h4>
        <p>Jugadores ordenados por <strong>categoría</strong> (de superior a inferior). Dentro de cada categoría, se ordenan por <strong>puntos</strong> (más arriba = mejor).</p>
        <div class="help-badges">
          <span class="chip ok">Zona de ascenso: Sí</span>
          <span class="chip info">Acción: Desafiar</span>
        </div>
      </section>

      <!-- Filtros -->
      <section class="help-card">
        <h4>
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
            <path d="M4 5h16M6 12h12M9 19h6" stroke="currentColor"/>
          </svg>
          Filtros
        </h4>
        <ul class="help-ul">
          <li><strong>Rama:</strong> Caballeros, Damas o Mixta.</li>
          <li><strong>Categoría:</strong> acota los resultados a un nivel.</li>
          <li><strong>Buscar jugador:</strong> filtrado instantáneo por nombre.</li>
        </ul>
      </section>

      <!-- Cómo se ordena -->
      <section class="help-card">
        <h4>
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
            <path d="M8 17l4-4 4 4M12 5v8" stroke="currentColor"/>
          </svg>
          Criterio de orden
        </h4>
        <ol class="help-ol">
          <li>Categorías: de mayor a menor (según su rango de puntos).</li>
          <li>Dentro de cada categoría: por <strong>puntos</strong> (descendente o lógica del torneo).</li>
        </ol>
      </section>

      <!-- Zona de ascenso y Rivales -->
      <section class="help-card">
        <h4>
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
            <circle cx="12" cy="12" r="9" stroke="currentColor"/>
          </svg>
          Zona de ascenso y Desafíos
        </h4>
        <ul class="help-ul">
          <li><strong>Zona de ascenso:</strong> si los puntos ≤ mínimo de tu categoría.</li>
          <li><strong>Rivales en nivel superior:</strong> cantidad de posibles rivales que podés desafiar arriba.</li>
          <li>Si estás en zona y hay rivales arriba, aparece el botón <em>Desafiar</em>.</li>
        </ul>
      </section>

      <!-- Ejemplo visual -->
      <section class="help-card">
        <h4>
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
            <rect x="4" y="4" width="16" height="16" rx="3" stroke="currentColor"/>
          </svg>
          Ejemplo visual
        </h4>
        <div class="help-visual">
          <svg width="260" height="110" viewBox="0 0 280 120" aria-hidden="true">
            <rect x="1" y="1" width="278" height="118" rx="10" fill="#0f172a" stroke="rgba(255,255,255,.12)"/>
            <rect x="16" y="14" width="248" height="18" rx="5" fill="#132238"/>
            <text x="140" y="27" fill="#9fb3c8" font-size="10" text-anchor="middle">Categoría A (rango alto)</text>

            <circle cx="36" y="60" r="10" fill="#22c55e"/>
            <text x="36" y="78" fill="#9aa3b2" font-size="9" text-anchor="middle">Ascenso</text>

            <rect x="72" y="52" width="84" height="16" rx="4" fill="#1b3b2a"/><text x="114" y="63" fill="#fff" font-size="9" text-anchor="middle">Desafiar</text>

            <rect x="16" y="88" width="248" height="18" rx="5" fill="#132238"/>
            <text x="140" y="101" fill="#9fb3c8" font-size="10" text-anchor="middle">Categoría B (rango bajo)</text>
          </svg>
        </div>
        <p class="muted" style="margin-top:4px;">El botón “Desafiar” aparece si el jugador está en zona de ascenso y existen rivales en la categoría superior.</p>
      </section>

      <!-- Tips -->
      <section class="help-card">
        <h4>
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
            <path d="M12 2l3 7h7l-5.5 4 2 7-6.5-4.5L5 20l2-7L1 9h7l4-7z" stroke="currentColor"/>
          </svg>
          Tips rápidos
        </h4>
        <ul class="help-ul">
          <li>Usá el buscador para ubicarte rápido.</li>
          <li>Si no ves el botón <em>Desafiar</em>, quizá no estás en zona o no hay rivales arriba.</li>
          <li>Filtrá por categoría para comparar pares justos.</li>
        </ul>
      </section>
    </div>
  </div>
</div>
{% endblock %}
