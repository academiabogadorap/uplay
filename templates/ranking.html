{% extends "base.html" %}
{% block title %}Ranking{% endblock %}

{% block content %}
<style>
  /* ===== Encabezado compacto ===== */
  .page-head{
    display:flex; align-items:flex-end; justify-content:space-between; gap:10px; flex-wrap:wrap;
    margin: 4px 0 10px;
  }
  .page-title{ margin:0; font-family:"Poppins",system-ui; font-weight:800; letter-spacing:.2px; }
  .page-sub{ margin:0; color:var(--muted,#9fb3c8); }

  /* ===== Filtros ===== */
  .filters.card{
    padding:10px; display:flex; gap:10px; align-items:center; flex-wrap:wrap;
  }
  .filters label{ font-weight:700; font-size:.92rem; }
  .filters select, .filters input[type="text"]{
    height:36px; padding:6px 8px; border-radius:10px;
    background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.16); color:var(--text);
    max-width:260px;
  }
  .filters .spacer{ flex:1; }

  /* ===== Tabla ===== */
  .table-wrap{
    --thead-h: 44px;
    max-height:70vh; overflow:auto; border-radius:12px;
    mask-image: linear-gradient(to bottom, rgba(0,0,0,1) 90%, rgba(0,0,0,0));
  }
  table.rank{
    width:100%; border-collapse:separate; border-spacing:0; margin:0;
  }
  .rank thead th{
    position:sticky; top:0; z-index:3;
    background:#0d1b2a; color:#dbe2ef; text-align:left;
    padding:10px 8px; height:var(--thead-h); line-height:1.1;
    text-transform:uppercase; letter-spacing:.02em;
    box-shadow:0 2px 0 rgba(0,0,0,.25);
    font-size:.86rem;
  }
  .rank tbody td{ padding:10px 8px; vertical-align:middle; }
  .rank tbody tr:not(.cat-sep):hover{ background:rgba(255,255,255,.04); }

  /* Separador de categoría “sticky” debajo del thead */
  .cat-sep{ position:sticky; top:var(--thead-h); z-index:2; }
  .cat-sep td{
    background:#132238; color:#9fb3c8; font-weight:700;
    border-top:1px solid rgba(255,255,255,.12);
    border-bottom:1px solid rgba(255,255,255,.12);
    padding:8px;
  }

  /* Resaltar jugador actual */
  .row-highlight{ outline:1px solid rgba(138,232,12,.35); background:rgba(138,232,12,.06); }

  /* Badges & botones */
  .badge{ display:inline-block; padding:2px 8px; border-radius:999px; background:rgba(255,255,255,.12); border:1px solid rgba(255,255,255,.18); font-size:.8rem; }
  .badge-ok{ background:#153c2a; border-color:#2a8b5f; }

  .btn{ cursor:pointer; }
  .btn-ghost{ background:rgba(255,255,255,.10); border:1px solid rgba(255,255,255,.18); }
  .btn-slim{ height:36px; padding:6px 10px; border-radius:10px; font-weight:700; }

  /* Responsive tweaks */
  @media (max-width:720px){
    .rank thead th:nth-child(5),
    .rank tbody td:nth-child(5),
    .rank thead th:nth-child(6),
    .rank tbody td:nth-child(6){
      display:none; /* ocultamos columnas menos críticas en mobile */
    }
    .filters{ padding:8px; }
  }
</style>

<div class="page-head">
  <div>
    <h2 class="page-title">Ranking</h2>
    <p class="page-sub">Superior → inferior. Dentro de cada nivel por puntos (más arriba = mejor).</p>
  </div>
</div>

<!-- ===== Filtros ===== -->
<form method="get" class="card filters" role="search" aria-label="Filtros de ranking">
  <label for="rama">Rama</label>
  <select id="rama" name="rama">
    <option value="">Todas</option>
    <option value="CABALLEROS" {% if rama_filtro == 'CABALLEROS' %}selected{% endif %}>Caballeros</option>
    <option value="DAMAS" {% if rama_filtro == 'DAMAS' %}selected{% endif %}>Damas</option>
    <option value="MIXTA" {% if rama_filtro == 'MIXTA' %}selected{% endif %}>Mixta</option>
  </select>

  <label for="categoria_id">Categoría</label>
  <select id="categoria_id" name="categoria_id">
    <option value="">Todas</option>
    {% for c in categorias_visible %}
      <option value="{{ c.id }}" {% if categoria_id == c.id %}selected{% endif %}>
        {{ c.nombre }} ({{ c.puntos_min }}–{{ c.puntos_max }})
      </option>
    {% endfor %}
  </select>

  <button type="submit" class="btn">Aplicar</button>
  <a href="{{ url_for('ranking') }}" class="btn btn-ghost">Limpiar</a>

  <div class="spacer"></div>
  <input id="searchBox" type="text" placeholder="Buscar jugador..." aria-label="Buscar jugador">
</form>

{% if grupos and grupos|length > 0 %}
  <div class="card" style="padding:0;">
    <div class="table-wrap">
      <table id="rankingTable" class="rank">
        <thead>
          <tr>
            <th style="width:56px;">#</th>
            <th>Nombre</th>
            <th>Puntos</th>
            <th>Categoría</th>
            <th>Zona ascenso</th>
            <th>Rivales sup.</th>
            <th style="width:140px;">Acción</th>
          </tr>
        </thead>
        <tbody>
          {% for cat, filas in grupos %}
            <tr class="cat-sep">
              <td colspan="7">{{ cat.nombre }} ({{ cat.puntos_min }}–{{ cat.puntos_max }})</td>
            </tr>

            {% if filas and filas|length > 0 %}
              {% for j in filas %}
                {% set es_yo = (current_jugador and j.id == current_jugador.id) %}
                <tr class="{% if es_yo %}row-highlight{% endif %}">
                  <td>{{ loop.index }}</td>
                  <td class="col-nombre">{{ j.nombre_completo }}</td>
                  <td>{{ j.puntos }}</td>
                  <td>{{ cat.nombre }}</td>
                  <td>
                    {% if zona_ascenso.get(j.id) %}
                      <span class="badge badge-ok">Sí</span>
                    {% else %}No{% endif %}
                  </td>
                  <td>{{ rivales_count.get(j.id, 0) }}</td>
                  <td>
                    {% if zona_ascenso.get(j.id) and rivales_count.get(j.id, 0) > 0 %}
                      <a href="{{ url_for('desafios_new', desafiante_id=j.id) }}" class="btn btn-slim">Desafiar</a>
                    {% else %}—{% endif %}
                  </td>
                </tr>
              {% endfor %}
            {% else %}
              <tr><td colspan="7" class="muted">Sin jugadores en esta categoría.</td></tr>
            {% endif %}
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
{% else %}
  <p class="muted">No hay jugadores suscriptos (o no hay categorías para la rama/categoría filtrada).</p>
{% endif %}

<script>
  // Filtro por nombre (cliente)
  (function () {
    const box = document.getElementById('searchBox');
    const table = document.getElementById('rankingTable');
    if (!box || !table) return;

    box.addEventListener('input', function () {
      const q = this.value.trim().toLowerCase();
      const rows = Array.from(table.querySelectorAll('tbody tr'));

      for (const r of rows) {
        if (r.classList.contains('cat-sep')) { r.style.display = ''; continue; }
        const nameCell = r.querySelector('.col-nombre');
        const visible = !q || (nameCell && nameCell.textContent.toLowerCase().includes(q));
        r.style.display = visible ? '' : 'none';
      }

      // Ocultar separadores sin filas visibles debajo
      for (let i = 0; i < rows.length; i++) {
        const sep = rows[i];
        if (!sep.classList.contains('cat-sep')) continue;
        let hasVisible = false;
        for (let j = i + 1; j < rows.length; j++) {
          if (rows[j].classList.contains('cat-sep')) break;
          if (rows[j].style.display !== 'none') { hasVisible = true; break; }
        }
        sep.style.display = hasVisible ? '' : 'none';
      }
    });
  })();
</script>
{% endblock %}

{% block help_content %}
<style>
  /* Ayuda compacta (mismo patrón que ya venimos usando) */
  .help-container{ display:flex; justify-content:center; width:100%; }
  .help-wrap{
    width:min(800px, 90vw); margin:0 auto;
    max-height:62dvh; max-height:62vh; overflow:auto; overscroll-behavior:contain;
    position:relative; background:transparent;
  }
  .help-head{
    position:sticky; top:0; z-index:2; display:flex; align-items:center; gap:6px;
    padding:6px 6px; margin-bottom:4px; background:var(--bg, rgba(10,12,20,.96));
    border-bottom:1px solid rgba(255,255,255,.06);
  }
  .help-title{ margin:0; font-size: clamp(.92rem, 2vw, 1.02rem); }
  .help-sub{ margin:0; color:var(--muted,#98a2b3); font-size: clamp(.78rem, 1.7vw, .88rem); }
  .help-grid{ display:grid; grid-template-columns: repeat(auto-fit, minmax(236px,1fr)); gap:8px; }
  .help-card{ background: rgba(255,255,255,.04); border:1px solid rgba(255,255,255,.08); border-radius:10px; padding:6px; }
  .help-card h4{ display:flex; align-items:center; gap:6px; margin:0 0 4px; font-size: clamp(.88rem, 1.9vw, .96rem); }
  .help-card p, .help-card li{ margin:3px 0; font-size: clamp(.78rem, 1.6vw, .86rem); line-height:1.3; }
  .help-ul, .help-ol{ padding-left:16px; margin:4px 0; }
  .help-badges{ display:flex; gap:6px; flex-wrap:wrap; margin-top:4px; }
  .chip{ display:inline-block; padding:2px 7px; border-radius:999px; font-size:.76rem; border:1px solid #2a2f45; background:#1b2138;}
  .chip.ok{ background:#1b3b2a; border-color:#1a704d; }
  .chip.info{ background:#1b2f3b; border-color:#1a4d70; }
</style>

<div class="help-container">
  <div class="help-wrap">
    <div class="help-head">
      <h3 class="help-title">¿Cómo leer el Ranking?</h3>
      <p class="help-sub">Guía rápida</p>
    </div>

    <div class="help-grid">
      <section class="help-card">
        <h4>Qué estás viendo</h4>
        <p>Jugadores ordenados por <strong>categoría</strong> (de superior a inferior) y, dentro de cada una, por <strong>puntos</strong>.</p>
        <div class="help-badges">
          <span class="chip ok">Zona de ascenso</span>
          <span class="chip info">Desafiar</span>
        </div>
      </section>

      <section class="help-card">
        <h4>Filtros</h4>
        <ul class="help-ul">
          <li><strong>Rama</strong> y <strong>Categoría</strong> para acotar la vista.</li>
          <li><strong>Buscar jugador</strong> filtra instantáneamente por nombre.</li>
        </ul>
      </section>

      <section class="help-card">
        <h4>Zona & Rivales</h4>
        <ul class="help-ul">
          <li>Si un jugador está en <strong>zona de ascenso</strong> y existen rivales arriba, verá el botón <em>Desafiar</em>.</li>
        </ul>
      </section>
    </div>
  </div>
</div>
{% endblock %}
